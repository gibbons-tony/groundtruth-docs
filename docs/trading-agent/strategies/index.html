<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-trading-agent/strategies" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Complete Trading Strategy Implementation Guide | Ground Truth</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://gibbons-tony.github.io/groundtruth-docs/img/caramanta-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://gibbons-tony.github.io/groundtruth-docs/img/caramanta-social-card.jpg"><meta data-rh="true" property="og:url" content="https://gibbons-tony.github.io/groundtruth-docs/docs/trading-agent/strategies"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Complete Trading Strategy Implementation Guide | Ground Truth"><meta data-rh="true" name="description" content="Comprehensive technical reference for all 10 trading strategies"><meta data-rh="true" property="og:description" content="Comprehensive technical reference for all 10 trading strategies"><link data-rh="true" rel="icon" href="/groundtruth-docs/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://gibbons-tony.github.io/groundtruth-docs/docs/trading-agent/strategies"><link data-rh="true" rel="alternate" href="https://gibbons-tony.github.io/groundtruth-docs/docs/trading-agent/strategies" hreflang="en"><link data-rh="true" rel="alternate" href="https://gibbons-tony.github.io/groundtruth-docs/docs/trading-agent/strategies" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Complete Trading Strategy Implementation Guide","item":"https://gibbons-tony.github.io/groundtruth-docs/docs/trading-agent/strategies"}]}</script><link rel="stylesheet" href="/groundtruth-docs/assets/css/styles.a3858ef3.css">
<script src="/groundtruth-docs/assets/js/runtime~main.264fa129.js" defer="defer"></script>
<script src="/groundtruth-docs/assets/js/main.fe2b1574.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/groundtruth-docs/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/groundtruth-docs/"><div class="navbar__logo"><img src="/groundtruth-docs/img/logo.svg" alt="Caramanta Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/groundtruth-docs/img/logo.svg" alt="Caramanta Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ground Truth</b></a><a class="navbar__item navbar__link" href="/groundtruth-docs/docs/overview">Overview</a><a class="navbar__item navbar__link" href="/groundtruth-docs/docs/research-agent/introduction">Research Agent</a><a class="navbar__item navbar__link" href="/groundtruth-docs/docs/forecast-agent/introduction">Forecast Agent</a><a class="navbar__item navbar__link" href="/groundtruth-docs/docs/trading-agent/introduction">Trading Agent</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://studiomios.wixstudio.com/caramanta" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Live System<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://github.com/gibbonstony/ucberkeley-capstone" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/groundtruth-docs/docs/overview"><span title="Overview" class="linkLabel_WmDU">Overview</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/groundtruth-docs/docs/forecast-agent/introduction"><span title="forecast-agent" class="categoryLinkLabel_W154">forecast-agent</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/groundtruth-docs/docs/research-agent/introduction"><span title="research-agent" class="categoryLinkLabel_W154">research-agent</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/groundtruth-docs/docs/trading-agent/introduction"><span title="trading-agent" class="categoryLinkLabel_W154">trading-agent</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/groundtruth-docs/docs/trading-agent/introduction"><span title="Trading Agent" class="linkLabel_WmDU">Trading Agent</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/groundtruth-docs/docs/trading-agent/strategies"><span title="Complete Trading Strategy Implementation Guide" class="linkLabel_WmDU">Complete Trading Strategy Implementation Guide</span></a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/groundtruth-docs/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">trading-agent</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Complete Trading Strategy Implementation Guide</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Complete Trading Strategy Implementation Guide</h1></header>
<p><strong>Comprehensive technical reference for all 10 trading strategies</strong></p>
<p>Based on actual Python implementation in <code>trading_agent/production/strategies/</code></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="table-of-contents">Table of Contents<a href="#table-of-contents" class="hash-link" aria-label="Direct link to Table of Contents" title="Direct link to Table of Contents" translate="no">​</a></h2>
<ol>
<li class=""><a href="#system-context" class="">System Context</a></li>
<li class=""><a href="#technical-indicators-explained" class="">Technical Indicators Explained</a></li>
<li class=""><a href="#cost-model" class="">Cost Model</a></li>
<li class=""><a href="#baseline-strategies" class="">Baseline Strategies (4)</a></li>
<li class=""><a href="#prediction-based-strategies" class="">Prediction-Based Strategies (5)</a></li>
<li class=""><a href="#optimization-strategy" class="">Optimization Strategy (1)</a></li>
<li class=""><a href="#academic-references" class="">Academic References</a></li>
<li class=""><a href="#design-decisions" class="">Design Decisions</a></li>
</ol>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="system-context">System Context<a href="#system-context" class="hash-link" aria-label="Direct link to System Context" title="Direct link to System Context" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="the-commodity-producer-scenario">The Commodity Producer Scenario<a href="#the-commodity-producer-scenario" class="hash-link" aria-label="Direct link to The Commodity Producer Scenario" title="Direct link to The Commodity Producer Scenario" translate="no">​</a></h3>
<p>This trading system is designed for <strong>commodity producers</strong> (coffee and sugar farmers) who face a specific challenge:</p>
<p><strong>Problem</strong>: You harvest 50 tons of coffee in May-September. When should you sell it?</p>
<p><strong>Constraints</strong>:</p>
<ol>
<li class=""><strong>Storage costs</strong>: 0.5% per day (inventory degrades, warehousing fees)</li>
<li class=""><strong>Transaction costs</strong>: 1% per sale (brokerage, logistics)</li>
<li class=""><strong>Quality degradation</strong>: Maximum 365 days before coffee goes bad</li>
<li class=""><strong>Price volatility</strong>: Coffee futures prices change daily</li>
<li class=""><strong>Limited foresight</strong>: You can only see 14 days ahead (forecast horizon)</li>
</ol>
<p><strong>Options</strong>:</p>
<ul>
<li class=""><strong>Sell immediately</strong>: Minimize storage costs, but might miss price increases</li>
<li class=""><strong>Wait for higher prices</strong>: Maximize revenue, but pay storage costs and risk price declines</li>
<li class=""><strong>Sell in batches</strong>: Spread risk across time (dollar-cost averaging)</li>
<li class=""><strong>Use forecasts</strong>: If you have price predictions, can you time sales better?</li>
</ul>
<p><strong>The Question</strong>: Can prediction-based strategies outperform simple baseline approaches?</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="harvest-cycle-management">Harvest Cycle Management<a href="#harvest-cycle-management" class="hash-link" aria-label="Direct link to Harvest Cycle Management" title="Direct link to Harvest Cycle Management" translate="no">​</a></h3>
<p><strong>Key Innovation</strong>: Inventory starts at <strong>ZERO</strong> and accumulates during harvest.</p>
<p>Traditional approach (wrong):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 1: Start with 50 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 2: Sell some</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 3: Sell more</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre></div></div>
<p>Realistic approach (ours):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Coffee harvest window: May 1 - September 30 (153 days)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Annual volume: 50 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Daily increment during harvest:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 50 tons / 153 days = 0.327 tons/day</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day May 1:    Inventory = 0 + 0.327 = 0.327 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day May 2:    Inventory = 0.327 + 0.327 = 0.654 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day May 3:    Inventory = 0.654 + 0.327 = 0.981 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day Sep 30:   Inventory = 49.673 + 0.327 = 50.000 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">After harvest (Oct 1+): No new inventory, only sales</span><br></span></code></pre></div></div>
<p>This is implemented in <code>backtest_engine.py:53-116</code>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_create_harvest_schedule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Calculate daily inventory increments during harvest windows.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Example (Coffee):</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        - Harvest: May-September (153 days)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        - Volume: 50 tons/year</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        - Daily increment: 50 / 153 = 0.327 tons/day</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    harvest_schedule </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> month_start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> month_end </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">harvest_windows</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Convert months to day-of-year</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        harvest_days </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_days</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">month_start</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> month_end</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        daily_increment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">harvest_volume </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> harvest_days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> day </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> harvest_days</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            harvest_schedule</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> daily_increment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> harvest_schedule</span><br></span></code></pre></div></div>
<p><strong>Why this matters</strong>: Strategies that sell aggressively early in harvest might run out of inventory later. Realistic harvest modeling ensures accurate backtesting.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="multi-year-backtesting">Multi-Year Backtesting<a href="#multi-year-backtesting" class="hash-link" aria-label="Direct link to Multi-Year Backtesting" title="Direct link to Multi-Year Backtesting" translate="no">​</a></h3>
<p>The system backtests strategies across <strong>5 years</strong> (2020-2024) to capture:</p>
<ul>
<li class="">Different market conditions (bull markets, bear markets, sideways)</li>
<li class="">Multiple harvest cycles (5 cycles per commodity)</li>
<li class="">Seasonal patterns</li>
<li class="">Price volatility variations</li>
</ul>
<p>Each year is treated as an independent trial for statistical testing.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="technical-indicators-explained">Technical Indicators Explained<a href="#technical-indicators-explained" class="hash-link" aria-label="Direct link to Technical Indicators Explained" title="Direct link to Technical Indicators Explained" translate="no">​</a></h2>
<p>All strategies use technical indicators to analyze market conditions. Here&#x27;s how they work.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="rsi-relative-strength-index">RSI (Relative Strength Index)<a href="#rsi-relative-strength-index" class="hash-link" aria-label="Direct link to RSI (Relative Strength Index)" title="Direct link to RSI (Relative Strength Index)" translate="no">​</a></h3>
<p><strong>Source</strong>: Wilder, J. Welles (1978). <em>New Concepts in Technical Trading Systems.</em></p>
<p><strong>Purpose</strong>: Identify overbought/oversold conditions.</p>
<p><strong>Formula</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RS = Average Gain (14 days) / Average Loss (14 days)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSI = 100 - (100 / (1 + RS))</span><br></span></code></pre></div></div>
<p><strong>Calculation</strong> (<code>indicators.py:10-36</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculate_rsi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> period</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Calculate Relative Strength Index</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        prices: Array of historical prices</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        period: RSI period (default 14)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        float: RSI value (0-100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> period </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50.0</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Neutral if insufficient history</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate price changes</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    deltas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">diff</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">period</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Separate gains and losses</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    gains </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deltas greater than </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deltas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    losses </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">deltas </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">deltas</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Average over period</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    avg_gain </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">gains</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    avg_loss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">losses</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> avg_loss </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100.0</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># All gains, maximum RSI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate RS and RSI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> avg_gain </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> avg_loss</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rsi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> rs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> rsi</span><br></span></code></pre></div></div>
<p><strong>Interpretation</strong>:</p>
<ul>
<li class=""><strong>RSI greater than 70</strong>: <strong>Overbought</strong> - Price may be too high, likely to fall soon</li>
<li class=""><strong>RSI &lt; 30</strong>: <strong>Oversold</strong> - Price may be too low, likely to rise soon</li>
<li class=""><strong>RSI ≈ 50</strong>: <strong>Neutral</strong> - No strong signal</li>
</ul>
<p><strong>Example</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Last 14 days of price changes:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[+2, +3, -1, +5, +2, -2, +1, +4, -3, +2, +1, -1, +3, +2] cents/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Gains: [2, 3, 0, 5, 2, 0, 1, 4, 0, 2, 1, 0, 3, 2] = 25 cents total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Losses: [0, 0, 1, 0, 0, 2, 0, 0, 3, 0, 0, 1, 0, 0] = 7 cents total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Average gain = 25 / 14 = 1.79</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Average loss = 7 / 14 = 0.50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RS = 1.79 / 0.50 = 3.58</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RSI = 100 - (100 / (1 + 3.58)) = 100 - 21.83 = 78.17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Interpretation: RSI = 78 greater than 70 → OVERBOUGHT (sell signal)</span><br></span></code></pre></div></div>
<p><strong>Usage in strategies</strong>:</p>
<ul>
<li class=""><code>PriceThresholdStrategy</code>: If RSI greater than 70, increase batch size (sell more)</li>
<li class=""><code>MovingAverageStrategy</code>: If RSI greater than 70 + downward crossover, sell aggressively</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="adx-average-directional-index">ADX (Average Directional Index)<a href="#adx-average-directional-index" class="hash-link" aria-label="Direct link to ADX (Average Directional Index)" title="Direct link to ADX (Average Directional Index)" translate="no">​</a></h3>
<p><strong>Source</strong>: Wilder, J. Welles (1978). <em>New Concepts in Technical Trading Systems.</em></p>
<p><strong>Purpose</strong>: Measure trend strength (NOT direction).</p>
<p><strong>Formula</strong> (simplified):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. Calculate True Range (TR) = max(High - Low, |High - Prev Close|, |Low - Prev Close|)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. Calculate Directional Movement:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - +DM = max(High - Prev High, 0)  if upward move</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - -DM = max(Prev Low - Low, 0)  if downward move</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. Calculate Directional Indicators:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - +DI = 100 × (+DM average / ATR)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - -DI = 100 × (-DM average / ATR)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. Calculate DX:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - DX = 100 × |+DI - -DI| / (+DI + -DI)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. ADX = Moving average of DX</span><br></span></code></pre></div></div>
<p><strong>Calculation</strong> (<code>indicators.py:39-86</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculate_adx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> period</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Calculate Average Directional Index</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        price_history: DataFrame with &#x27;price&#x27; column (and optionally &#x27;high&#x27;/&#x27;low&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        period: ADX period (default 14)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        tuple: (adx, plus_di, minus_di)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> period </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Neutral if insufficient history</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Get high/low (use price if not available)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;high&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">columns </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;low&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">columns</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        high </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;high&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        low </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;low&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        high </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        low </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    close </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate True Range</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">maximum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">high</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> low</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">maximum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">high</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> close</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              </span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">low</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> close</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate Directional Movement</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    plus_dm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">high</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> high</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> greater than </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">low</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> low</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">maximum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">high</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> high</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    minus_dm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">where</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">low</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> low</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> greater than </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">high</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> high</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">maximum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">low</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> low</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate Average True Range</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    atr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tr</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">period</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> atr greater than </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate Directional Indicators</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        plus_di </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">plus_dm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">period</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> atr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        minus_di </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">minus_dm</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">period</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> atr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        plus_di </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        minus_di </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate DX</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    di_sum </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> plus_di </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> minus_di</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> di_sum greater than </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token builtin">abs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">plus_di </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> minus_di</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> di_sum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        adx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dx  </span><span class="token comment" style="color:#999988;font-style:italic"># Simplified (should be smoothed)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        adx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> adx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> plus_di</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> minus_di</span><br></span></code></pre></div></div>
<p><strong>Interpretation</strong>:</p>
<ul>
<li class=""><strong>ADX greater than 25</strong>: <strong>Strong trend</strong> (either upward or downward)</li>
<li class=""><strong>ADX &lt; 20</strong>: <strong>Weak trend</strong> (choppy, sideways market)</li>
<li class=""><strong>+DI greater than -DI</strong>: Upward trend</li>
<li class=""><strong>-DI greater than +DI</strong>: Downward trend</li>
</ul>
<p><strong>Example</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Price data (10 days):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">High:  [200, 205, 210, 208, 212, 215, 218, 220, 222, 225]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Low:   [195, 200, 205, 203, 207, 210, 213, 215, 217, 220]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Close: [198, 203, 208, 206, 210, 213, 216, 218, 220, 223]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">True Range (last 9 days):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TR = max(H-L, |H-PrevClose|, |L-PrevClose|)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TR[1] = max(205-200, |205-198|, |200-198|) = max(5, 7, 2) = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TR[2] = max(210-205, |210-203|, |205-203|) = max(5, 7, 2) = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+DM (upward moves):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+DM[1] = max(205-200, 0) if (205-200) greater than (195-200) = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+DM[2] = max(210-205, 0) if (210-205) greater than (200-205) = 5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-DM (downward moves):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-DM[1] = 0 (upward move)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-DM[2] = 0 (upward move)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ATR = mean(TR) = 6.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">+DI = 100 × mean(+DM) / ATR = 100 × 4.2 / 6.5 = 64.6</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-DI = 100 × mean(-DM) / ATR = 100 × 0.8 / 6.5 = 12.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">DX = 100 × |64.6 - 12.3| / (64.6 + 12.3) = 100 × 52.3 / 76.9 = 68.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ADX = 68.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Interpretation: ADX = 68 greater than 25 → STRONG TREND (upward, since +DI greater than -DI)</span><br></span></code></pre></div></div>
<p><strong>Usage in strategies</strong>:</p>
<ul>
<li class=""><code>PriceThresholdStrategy</code>: If ADX greater than 25 + RSI greater than 70, very strong signal (sell more)</li>
<li class=""><code>MovingAverageStrategy</code>: If ADX greater than 25 + price above MA, strong uptrend (hold longer)</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="cv-coefficient-of-variation">CV (Coefficient of Variation)<a href="#cv-coefficient-of-variation" class="hash-link" aria-label="Direct link to CV (Coefficient of Variation)" title="Direct link to CV (Coefficient of Variation)" translate="no">​</a></h3>
<p><strong>Purpose</strong>: Measure forecast uncertainty (prediction confidence).</p>
<p><strong>Formula</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CV = σ / μ</span><br></span></code></pre></div></div>
<p>Where:</p>
<ul>
<li class="">σ = Standard deviation of predictions</li>
<li class="">μ = Median of predictions</li>
</ul>
<p><strong>Calculation</strong> (<code>indicators.py:110-133</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">calculate_prediction_confidence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> horizon_day</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Calculate confidence from prediction ensemble using coefficient of variation</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        predictions: numpy array (n_paths, n_horizons)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">                    e.g., (2000 paths, 14 days)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        horizon_day: Which horizon to evaluate (0-indexed)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        float: Coefficient of variation (std_dev / median)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> predictions </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Maximum uncertainty</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> horizon_day greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        horizon_day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Get all 2,000 predictions for this day</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    day_predictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> horizon_day</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate median and std dev</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    median_pred </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">median</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day_predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">std</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day_predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Coefficient of variation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std_dev </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> median_pred </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> median_pred greater than </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> cv</span><br></span></code></pre></div></div>
<p><strong>Interpretation</strong>:</p>
<ul>
<li class=""><strong>CV &lt; 0.05 (5%)</strong>: <strong>HIGH confidence</strong> - Predictions agree strongly</li>
<li class=""><strong>CV &lt; 0.15 (15%)</strong>: <strong>MEDIUM confidence</strong> - Moderate agreement</li>
<li class=""><strong>CV ≥ 0.15</strong>: <strong>LOW confidence</strong> - Predictions vary widely</li>
</ul>
<p><strong>Example</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">2,000 forecast paths for day 14:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Prices range from $1.95 to $2.05 per lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Median = $2.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Std dev = $0.08</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CV = $0.08 / $2.00 = 0.04 = 4%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Interpretation: CV = 4% &lt; 5% → HIGH CONFIDENCE</span><br></span></code></pre></div></div>
<p><strong>Why median instead of mean?</strong></p>
<ul>
<li class="">Robust to outliers</li>
<li class="">If 1 path predicts $10 (outlier), median unchanged</li>
<li class="">Mean would shift significantly</li>
</ul>
<p><strong>Usage in prediction strategies</strong>:</p>
<ul>
<li class="">All prediction-based strategies use CV to determine confidence level</li>
<li class="">HIGH confidence (CV &lt; 5%): Trust predictions, override baseline</li>
<li class="">MEDIUM confidence (CV &lt; 15%): Blend predictions with baseline</li>
<li class="">LOW confidence (CV ≥ 15%): Ignore predictions, use baseline</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="moving-average-ma">Moving Average (MA)<a href="#moving-average-ma" class="hash-link" aria-label="Direct link to Moving Average (MA)" title="Direct link to Moving Average (MA)" translate="no">​</a></h3>
<p><strong>Purpose</strong>: Smooth price data to identify trend.</p>
<p><strong>Formula</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MA_n = (P_1 + P_2 + ... + P_n) / n</span><br></span></code></pre></div></div>
<p><strong>Example</strong> (30-day MA):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Last 30 prices:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[195, 196, 198, 200, 202, 203, 205, 207, 208, 210, ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MA_30 = (195 + 196 + ... + 210) / 30 = 202.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current price = 208</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Price vs MA = 208 / 202.5 = 1.027 = 2.7% above MA</span><br></span></code></pre></div></div>
<p><strong>Crossover Detection</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Yesterday:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Price = 201</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MA = 202</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Status: Price BELOW MA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Today:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Price = 204</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MA = 203</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Status: Price ABOVE MA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">→ UPWARD CROSSOVER (price crossed UP through MA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">→ Bullish signal (trend reversing from falling to rising)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="cost-model">Cost Model<a href="#cost-model" class="hash-link" aria-label="Direct link to Cost Model" title="Direct link to Cost Model" translate="no">​</a></h2>
<p>All strategies account for two costs:</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="storage-cost">Storage Cost<a href="#storage-cost" class="hash-link" aria-label="Direct link to Storage Cost" title="Direct link to Storage Cost" translate="no">​</a></h3>
<p><strong>Rate</strong>: 0.5% per day (0.005% in code)</p>
<p><strong>Rationale</strong> (from <code>CHANGELOG.md:2025-12-04</code>):</p>
<ul>
<li class="">Warehouse rental</li>
<li class="">Handling fees</li>
<li class="">Quality degradation</li>
<li class="">Insurance</li>
</ul>
<p><strong>Calculation</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">storage_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price × </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.005</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> × days_stored</span><br></span></code></pre></div></div>
<p><strong>Example</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Price = $2.00/lb = $4,000/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Days stored = 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Storage cost = $4,000 × (0.005 / 100) × 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             = $4,000 × 0.00005 × 30</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             = $6.00/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Over 30 days: $6.00/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Over 365 days: $73.00/ton (1.825% of value)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="transaction-cost">Transaction Cost<a href="#transaction-cost" class="hash-link" aria-label="Direct link to Transaction Cost" title="Direct link to Transaction Cost" translate="no">​</a></h3>
<p><strong>Rate</strong>: 1% per sale (0.01% in code)</p>
<p><strong>Rationale</strong>:</p>
<ul>
<li class="">Brokerage fees</li>
<li class="">Logistics (transport to warehouse/port)</li>
<li class="">Quality inspection</li>
<li class="">Documentation</li>
</ul>
<p><strong>Calculation</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">transaction_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sale_price × </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.01</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Example</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Sale price = $2.00/lb = $4,000/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Amount sold = 12.5 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Revenue = 12.5 × $4,000 = $50,000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transaction cost = $50,000 × (0.01 / 100) = $5.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net revenue = $50,000 - $5.00 = $49,995</span><br></span></code></pre></div></div>
<p><strong>Why these rates?</strong></p>
<ul>
<li class="">Based on diagnostic research with real producer data</li>
<li class="">Validated against industry standards</li>
<li class="">Conservative estimates (actual costs may be higher)</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="baseline-strategies">Baseline Strategies<a href="#baseline-strategies" class="hash-link" aria-label="Direct link to Baseline Strategies" title="Direct link to Baseline Strategies" translate="no">​</a></h2>
<p>Baseline strategies do NOT use forecasts. They serve as benchmarks to evaluate whether predictions add value.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="1-immediate-sale-strategy">1. Immediate Sale Strategy<a href="#1-immediate-sale-strategy" class="hash-link" aria-label="Direct link to 1. Immediate Sale Strategy" title="Direct link to 1. Immediate Sale Strategy" translate="no">​</a></h3>
<p><strong>File</strong>: <code>baseline.py:29-71</code></p>
<p><strong>Purpose</strong>: Naive baseline - sell everything weekly.</p>
<p><strong>Algorithm</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Every 7 days:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  If inventory greater than or equal to  min_batch_size:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Sell ALL inventory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Else:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Wait for more accumulation</span><br></span></code></pre></div></div>
<p><strong>Decision Logic</strong> (<code>baseline.py:44-66</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> inventory less than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;no_inventory&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Force liquidation check (365 days max)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forced </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_force_liquidation_check</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> forced</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> forced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Check if it&#x27;s time to sell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ready_to_sell </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">days_since_last_sale greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sale_frequency_days</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    enough_inventory </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inventory greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min_batch_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ready_to_sell </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> enough_inventory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">days_since_last_sale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;SELL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Sell ALL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;immediate_weekly_sale_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">inventory</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.1f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">t&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Wait</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">days_since_last_sale </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> enough_inventory</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;accumulating_need_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">min_batch_size</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.1f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">t&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;waiting_for_sale_day_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">days_since_last_sale</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Parameters</strong>:</p>
<ul>
<li class=""><code>min_batch_size</code>: 5.0 tons (don&#x27;t sell tiny amounts)</li>
<li class=""><code>sale_frequency_days</code>: 7 (weekly sales)</li>
</ul>
<p><strong>Example Execution</strong> (Coffee harvest):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Harvest: May 1 - Sep 30 (153 days)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Daily increment: 50 / 153 = 0.327 tons/day</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 1 (May 1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Inventory = 0.327 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Days since sale = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  0.327 &lt; 5.0 → HOLD (accumulate)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 7 (May 7):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Inventory = 2.289 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Days since sale = 13</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2.289 &lt; 5.0 → HOLD (still accumulating)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 15 (May 15):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Inventory = 4.905 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Days since sale = 21</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4.905 &lt; 5.0 → HOLD (almost there)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 16 (May 16):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Inventory = 5.232 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Days since sale = 22</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  22 greater than or equal to  7 AND 5.232 greater than or equal to  5.0 → SELL ALL 5.232 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Days since sale reset to 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 23 (May 23):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Inventory = 2.289 tons (accumulated since last sale)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Days since sale = 7</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2.289 &lt; 5.0 → HOLD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">... continues weekly</span><br></span></code></pre></div></div>
<p><strong>Academic Context</strong>:</p>
<ul>
<li class=""><strong>NO specific citation</strong> - This is an industry-standard naive baseline</li>
<li class="">Represents &quot;sell as soon as possible&quot; farmer behavior</li>
<li class="">Minimizes storage costs</li>
<li class="">Ignores all market signals</li>
<li class="">Expected to underperform but provides lower bound</li>
</ul>
<p><strong>Why this design?</strong>:</p>
<ul>
<li class="">Simplest possible strategy</li>
<li class="">Easy to understand and implement</li>
<li class="">Provides baseline for comparison</li>
<li class="">If prediction strategies can&#x27;t beat this, they have no value</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="2-equal-batch-strategy">2. Equal Batch Strategy<a href="#2-equal-batch-strategy" class="hash-link" aria-label="Direct link to 2. Equal Batch Strategy" title="Direct link to 2. Equal Batch Strategy" translate="no">​</a></h3>
<p><strong>File</strong>: <code>baseline.py:73-108</code></p>
<p><strong>Purpose</strong>: Systematic liquidation - sell fixed percentages on schedule.</p>
<p><strong>Algorithm</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Every 30 days:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Sell 25% of current inventory</span><br></span></code></pre></div></div>
<p><strong>Decision Logic</strong> (<code>baseline.py:88-103</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> inventory less than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;no_inventory&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forced </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_force_liquidation_check</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> forced</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> forced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    days_since_sale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_sale_day</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> days_since_sale greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">frequency</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        amount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inventory </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_sale_day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> day</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;SELL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> amount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;scheduled_batch&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;waiting_for_schedule&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Parameters</strong>:</p>
<ul>
<li class=""><code>batch_size</code>: 0.25 (sell 25% each time)</li>
<li class=""><code>frequency_days</code>: 30 (monthly batches)</li>
</ul>
<p><strong>Example Execution</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 0:   Inventory = 50 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 30:  Sell 50 × 0.25 = 12.5 tons, keep 37.5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 60:  Sell 37.5 × 0.25 = 9.375 tons, keep 28.125</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 90:  Sell 28.125 × 0.25 = 7.031 tons, keep 21.094</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 120: Sell 21.094 × 0.25 = 5.274 tons, keep 15.820</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 150: Sell 15.820 × 0.25 = 3.955 tons, keep 11.865</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 180: Sell 11.865 × 0.25 = 2.966 tons, keep 8.899</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 210: Sell 8.899 × 0.25 = 2.225 tons, keep 6.674</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 240: Sell 6.674 × 0.25 = 1.669 tons, keep 5.006</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 270: Sell 5.006 × 0.25 = 1.252 tons, keep 3.754</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 300: Sell 3.754 × 0.25 = 0.939 tons, keep 2.816</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 330: Sell 2.816 × 0.25 = 0.704 tons, keep 2.112</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 360: Sell 2.112 × 0.25 = 0.528 tons, keep 1.584</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 365: Force liquidate remaining 1.584 tons</span><br></span></code></pre></div></div>
<p><strong>Academic Context</strong>:</p>
<ul>
<li class=""><strong>No strong academic endorsement</strong></li>
<li class="">Reverse dollar-cost averaging</li>
<li class="">Research suggests this is suboptimal (reduces expected returns)</li>
<li class="">Practitioner heuristic, not research-based</li>
</ul>
<p><strong>When to cite</strong>:
Describe as &quot;systematic liquidation with periodic review&quot; or &quot;fixed-fraction disposal policy&quot; without citing specific paper.</p>
<p><strong>Why this design?</strong>:</p>
<ul>
<li class="">Spreads risk across time</li>
<li class="">Avoids timing the market</li>
<li class="">Common real-world approach</li>
<li class="">Smooths price volatility impact</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="3-price-threshold-strategy">3. Price Threshold Strategy<a href="#3-price-threshold-strategy" class="hash-link" aria-label="Direct link to 3. Price Threshold Strategy" title="Direct link to 3. Price Threshold Strategy" translate="no">​</a></h3>
<p><strong>File</strong>: <code>baseline.py:110-218</code></p>
<p><strong>Purpose</strong>: Technical analysis baseline - sell when price crosses above MA threshold.</p>
<p><strong>Algorithm</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. Calculate 30-day moving average (MA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. Set threshold = MA × (1 + threshold_pct)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. If price greater than threshold:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   a. Calculate RSI and ADX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   b. Determine batch size based on indicators</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   c. Sell batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. If no sale in 60 days:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Sell anyway (fallback)</span><br></span></code></pre></div></div>
<p><strong>Decision Logic</strong> (<code>baseline.py:154-188</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> inventory less than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;no_inventory&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forced </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_force_liquidation_check</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> forced</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> forced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    days_since_sale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_sale_day</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate threshold based on 30-day MA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ma_30 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threshold </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ma_30 </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threshold_pct</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threshold </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threshold_pct</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    signal_triggered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price greater than threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    can_trade </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> days_since_sale greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cooldown_days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> signal_triggered</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Below threshold - wait</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> days_since_sale greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_days_without_sale</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Fallback after 60 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_trade</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_baseline</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;fallback_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">days_since_sale</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">d&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;below_threshold_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">current_price</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">threshold</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> can_trade</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Cooldown period</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;cooldown_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">cooldown_days </span><span class="token string-interpolation interpolation operator" style="color:#393A34">-</span><span class="token string-interpolation interpolation"> days_since_sale</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">d&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Signal triggered - analyze with indicators</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_analyze_historical</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_trade</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Indicator Analysis</strong> (<code>baseline.py:189-208</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_analyze_historical</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Analyze using historical technical indicators&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rsi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_rsi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> period</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    adx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_adx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> period</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> rsi greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsi_overbought </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> adx greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adx_strong</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Overbought + strong trend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_overbought_strong  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.35</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;overbought_strong_trend_rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> rsi greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsi_overbought</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Overbought only</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_overbought  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;overbought_rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> adx greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adx_strong </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> rsi </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsi_moderate</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Strong trend but not overbought</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_strong_trend  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;strong_trend_rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Baseline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_baseline  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;baseline_rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><br></span></code></pre></div></div>
<p><strong>Parameters</strong>:</p>
<ul>
<li class=""><code>threshold_pct</code>: 0.05 (trigger when price greater than MA × 1.05)</li>
<li class=""><code>batch_baseline</code>: 0.25</li>
<li class=""><code>batch_overbought_strong</code>: 0.35</li>
<li class=""><code>batch_overbought</code>: 0.30</li>
<li class=""><code>batch_strong_trend</code>: 0.20</li>
<li class=""><code>rsi_overbought</code>: 70</li>
<li class=""><code>rsi_moderate</code>: 65</li>
<li class=""><code>adx_strong</code>: 25</li>
<li class=""><code>cooldown_days</code>: 7</li>
<li class=""><code>max_days_without_sale</code>: 60</li>
</ul>
<p><strong>Example Execution</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 50:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Current price = $2.05/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  30-day MA = $1.95/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Threshold = $1.95 × 1.05 = $2.0475/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  $2.05 greater than $2.0475 → Signal TRIGGERED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Days since last sale = 10 greater than or equal to  7 (cooldown passed)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Calculate indicators:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RSI = 72 (overbought)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ADX = 28 (strong trend)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RSI greater than 70 AND ADX greater than 25 → Overbought + strong trend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Batch size = 0.35 (sell 35%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Inventory = 40 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Sell 40 × 0.35 = 14 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Return: SELL 14 tons, reason = &quot;overbought_strong_trend_rsi72_adx28&quot;</span><br></span></code></pre></div></div>
<p><strong>Academic References</strong>:</p>
<ul>
<li class=""><strong>Wilder (1978)</strong> for RSI and ADX indicators</li>
<li class=""><strong>Marshall et al. (2008)</strong> &quot;Can commodity futures be profitably traded with quantitative market timing strategies?&quot; <em>Journal of Banking &amp; Finance</em>
<ul>
<li class="">Comprehensive examination of quantitative trading rules in commodity futures</li>
<li class="">Tests 15 major commodity futures series</li>
</ul>
</li>
<li class=""><strong>Brock et al. (1992)</strong> &quot;Simple technical trading rules and the stochastic properties of stock returns&quot; <em>Journal of Finance</em>
<ul>
<li class="">Academic validation of moving average strategies</li>
</ul>
</li>
</ul>
<p><strong>Why this design?</strong>:</p>
<ul>
<li class="">Combines price momentum (threshold) with technical confirmation (RSI/ADX)</li>
<li class="">Cooldown prevents overtrading (transaction costs add up)</li>
<li class="">Fallback prevents holding too long in flat markets</li>
<li class="">Adaptive batch sizing based on signal strength</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="4-moving-average-strategy">4. Moving Average Strategy<a href="#4-moving-average-strategy" class="hash-link" aria-label="Direct link to 4. Moving Average Strategy" title="Direct link to 4. Moving Average Strategy" translate="no">​</a></h3>
<p><strong>File</strong>: <code>baseline.py:220-340</code></p>
<p><strong>Purpose</strong>: Crossover detection - sell when price crosses down through MA.</p>
<p><strong>Algorithm</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. Calculate 30-day moving average (MA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. Detect crossovers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Upward cross (price crosses UP): HOLD (bullish)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Downward cross (price crosses DOWN): SELL (bearish)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. If downward cross:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   a. Calculate RSI and ADX</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   b. Determine batch size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   c. Sell batch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. If no sale in 60 days:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   Sell anyway (fallback)</span><br></span></code></pre></div></div>
<p><strong>Crossover Detection</strong> (<code>baseline.py:284-310</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Get last 31 prices</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">recent_prices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">period </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Calculate moving averages</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ma_current </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recent_prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Last 30 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ma_prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">recent_prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">31</span><span class="token punctuation" style="color:#393A34">:</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># Previous 30 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">prev_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> recent_prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Detect crossover directions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upward_cross </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prev_price less than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  ma_prev </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> current_price greater than ma_current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">downward_cross </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prev_price greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  ma_prev </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> current_price </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> ma_current</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Upward crossover: Transition from falling to rising - HOLD</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> upward_cross</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;upward_crossover_bullish&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Downward crossover: Transition from rising to falling - SELL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> downward_cross</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> can_trade</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;cooldown_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">cooldown_days </span><span class="token string-interpolation interpolation operator" style="color:#393A34">-</span><span class="token string-interpolation interpolation"> days_since_sale</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">d&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Analyze with indicators</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_analyze_historical</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_trade</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># No crossover: maintain position</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;no_crossover&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Indicator Analysis</strong> (<code>baseline.py:312-331</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_analyze_historical</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Analyze using historical technical indicators&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    prices </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">values</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rsi </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_rsi</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">prices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> period</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    adx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_adx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> period</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> adx greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adx_strong </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> rsi greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsi_min </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> rsi less than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsi_overbought</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Strong momentum</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_strong_momentum  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;strong_momentum_rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> rsi greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsi_overbought </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> adx greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">adx_strong</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Overbought + strong trend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_overbought_strong  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.35</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;overbought_strong_rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> rsi greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsi_overbought</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Overbought only</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_overbought  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.30</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;overbought_rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Baseline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_baseline  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;baseline_rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">rsi</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">adx</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><br></span></code></pre></div></div>
<p><strong>Parameters</strong>:</p>
<ul>
<li class=""><code>ma_period</code>: 30 (30-day moving average)</li>
<li class=""><code>batch_baseline</code>: 0.25</li>
<li class=""><code>batch_strong_momentum</code>: 0.20</li>
<li class=""><code>batch_overbought_strong</code>: 0.35</li>
<li class=""><code>batch_overbought</code>: 0.30</li>
<li class=""><code>rsi_overbought</code>: 70</li>
<li class=""><code>rsi_min</code>: 45</li>
<li class=""><code>adx_strong</code>: 25</li>
<li class=""><code>adx_weak</code>: 20</li>
<li class=""><code>cooldown_days</code>: 7</li>
<li class=""><code>max_days_without_sale</code>: 60</li>
</ul>
<p><strong>Example Execution</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 75:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Current price = $1.98/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MA (days 45-74) = $2.02/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MA (days 46-75) = $2.00/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Yesterday:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Price = $2.03/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MA = $2.02/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Status: Price ABOVE MA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Today:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Price = $1.98/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MA = $2.00/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Status: Price BELOW MA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Detection: DOWNWARD CROSSOVER</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (Price crossed DOWN through MA → Bearish signal)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Days since last sale = 12 greater than or equal to  7 (cooldown passed)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Calculate indicators:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RSI = 55 (neutral)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ADX = 30 (strong trend)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ADX greater than 25 AND RSI between 45-70 → Strong momentum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Batch size = 0.20 (sell 20%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Inventory = 35 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Sell 35 × 0.20 = 7 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Return: SELL 7 tons, reason = &quot;strong_momentum_rsi55_adx30&quot;</span><br></span></code></pre></div></div>
<p><strong>Academic References</strong>:</p>
<ul>
<li class=""><strong>Marshall et al. (2008)</strong> - Most appropriate for commodity MA strategies</li>
<li class=""><strong>Brock et al. (1992)</strong> - Comprehensive MA study (stock-focused but validates approach)</li>
<li class=""><strong>Wilder (1978)</strong> - For RSI/ADX indicators</li>
</ul>
<p><strong>Why this design?</strong>:</p>
<ul>
<li class="">Classic technical analysis pattern</li>
<li class="">Downward crossover signals trend reversal (rising → falling)</li>
<li class="">Upward crossover signals bullish trend (hold for higher prices)</li>
<li class="">Avoids selling into rising markets</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="prediction-based-strategies">Prediction-Based Strategies<a href="#prediction-based-strategies" class="hash-link" aria-label="Direct link to Prediction-Based Strategies" title="Direct link to Prediction-Based Strategies" translate="no">​</a></h2>
<p>These strategies use 14-day price forecasts (2,000 Monte Carlo paths) to make decisions.</p>
<p><strong>Key Innovation: 3-Tier Confidence System</strong></p>
<p>All prediction-based matched pairs use this system:</p>
<p><strong>Tier 1: HIGH Confidence (CV &lt; 5%)</strong></p>
<ul>
<li class=""><strong>Action</strong>: OVERRIDE baseline completely</li>
<li class=""><strong>Logic</strong>: Predictions are highly certain, trust them fully</li>
<li class=""><strong>Example</strong>: If predictions show strong upward trend with 4% CV, HOLD regardless of baseline signal</li>
</ul>
<p><strong>Tier 2: MEDIUM Confidence (CV &lt; 15%)</strong></p>
<ul>
<li class=""><strong>Action</strong>: BLEND baseline + predictions</li>
<li class=""><strong>Logic</strong>: Moderate certainty, use both signals</li>
<li class=""><strong>Example</strong>: If baseline says SELL and predictions say HOLD, reduce sell amount by 50%</li>
</ul>
<p><strong>Tier 3: LOW Confidence (CV ≥ 15%)</strong></p>
<ul>
<li class=""><strong>Action</strong>: FOLLOW baseline exactly</li>
<li class=""><strong>Logic</strong>: Predictions too uncertain, ignore them</li>
<li class=""><strong>Example</strong>: Execute baseline strategy as if predictions don&#x27;t exist</li>
</ul>
<p>This ensures fair A/B testing between baseline and prediction-augmented strategies.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="5-price-threshold-predictive-matched-pair">5. Price Threshold Predictive (Matched Pair)<a href="#5-price-threshold-predictive-matched-pair" class="hash-link" aria-label="Direct link to 5. Price Threshold Predictive (Matched Pair)" title="Direct link to 5. Price Threshold Predictive (Matched Pair)" translate="no">​</a></h3>
<p><strong>File</strong>: <code>prediction.py:46-380</code></p>
<p><strong>Purpose</strong>: Augment Price Threshold baseline with forecast-driven overrides.</p>
<p><strong>Matched Pair Design</strong>:</p>
<ul>
<li class=""><strong>Baseline</strong>: PriceThresholdStrategy (no forecasts)</li>
<li class=""><strong>Augmented</strong>: This strategy (with prediction capability)</li>
<li class=""><strong>Goal</strong>: Measure value added by predictions</li>
</ul>
<p><strong>Decision Hierarchy</strong> (<code>prediction.py:124-166</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    DECISION HIERARCHY:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    1. Forced liquidation (always highest priority)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    2. Cooldown check</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    3. Prediction signal analysis (if available)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    4. Baseline signal (if no predictions or low confidence)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> inventory less than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;no_inventory&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    forced </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_force_liquidation_check</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> forced</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> forced</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    days_since_sale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_sale_day</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> days_since_sale </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cooldown_days</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;cooldown_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">cooldown_days </span><span class="token string-interpolation interpolation operator" style="color:#393A34">-</span><span class="token string-interpolation interpolation"> days_since_sale</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">d&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Analyze predictions if available</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> predictions </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size greater than </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        pred_signal </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_analyze_prediction_signal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># HIGH CONFIDENCE → OVERRIDE BASELINE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;confidence&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HIGH&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_prediction_override</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># MEDIUM CONFIDENCE → BLEND WITH BASELINE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;confidence&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MEDIUM&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_blended_decision</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pred_signal</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># LOW/NO CONFIDENCE → FOLLOW BASELINE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_baseline_logic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Prediction Signal Analysis</strong> (<code>prediction.py:168-209</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_analyze_prediction_signal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Analyze predictions to determine:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    1. Direction (upward/downward/neutral)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    2. Magnitude (strong/moderate/weak)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    3. Confidence (high/medium/low)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># predictions is (2000 paths × 14 days) matrix</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate net benefit across all horizons</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    net_benefit_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_calculate_net_benefit_pct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate prediction confidence (CV at day 14)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    day_14_predictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2,000 values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    median </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">median</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day_14_predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std_dev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">std</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day_14_predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std_dev </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> median</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Determine confidence level</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">high_confidence_cv</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># CV &lt; 5%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        confidence </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HIGH&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">medium_confidence_cv</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># CV &lt; 15%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        confidence </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MEDIUM&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        confidence </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;LOW&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Determine direction and magnitude</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> net_benefit_pct greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strong_positive_threshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> greater than </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> percent net benefit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        direction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;STRONG_UPWARD&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> net_benefit_pct greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">moderate_threshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> plus </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> minus </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain"> percent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        direction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MODERATE_UPWARD&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> net_benefit_pct </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strong_negative_threshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> less than </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> percent net benefit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        direction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;STRONG_DOWNWARD&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> net_benefit_pct less than </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">moderate_threshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> plus </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> minus </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain"> percent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        direction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MODERATE_DOWNWARD&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        direction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;NEUTRAL&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;confidence&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> confidence</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;direction&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> direction</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;net_benefit_pct&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> net_benefit_pct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;cv&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Net Benefit Calculation</strong> (<code>prediction.py:351-371</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_calculate_net_benefit_pct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Calculate net benefit as percentage:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    (best_future_value - sell_today_value) / current_price * 100</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Accounts for storage and transaction costs.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Find optimal day to sell in 14-day window</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ev_by_day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> day </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Use median of 2,000 paths as expected price</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">median</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        days_to_wait </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate costs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storage_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_cost_pct_per_day </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> days_to_wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transaction_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> future_price </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_cost_pct </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Expected value if we sell on this day</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> future_price </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> storage_cost </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> transaction_cost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ev_by_day</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Compare to selling today</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transaction_cost_today </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_cost_pct </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ev_today </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> transaction_cost_today</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Find best option</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimal_ev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ev_by_day</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    net_benefit_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">optimal_ev </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ev_today</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> current_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> net_benefit_pct</span><br></span></code></pre></div></div>
<p><strong>HIGH Confidence Override</strong> (<code>prediction.py:211-244</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_execute_prediction_override</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    HIGH CONFIDENCE: Predictions override baseline completely</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    direction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;direction&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    net_benefit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;net_benefit_pct&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;cv&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> direction </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;STRONG_UPWARD&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Strong evidence prices will rise → HOLD completely</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_pred_hold  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;OVERRIDE_hold_strong_upward_net</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> direction </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MODERATE_UPWARD&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Moderate upward → Small hedge</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_pred_cautious  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;OVERRIDE_small_hedge_mod_upward_net</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> direction </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;STRONG_DOWNWARD&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Strong evidence prices will fall → SELL aggressively</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_pred_aggressive  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.40</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;OVERRIDE_aggressive_strong_downward_net</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> direction </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MODERATE_DOWNWARD&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Moderate downward → Sell baseline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_baseline  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;OVERRIDE_baseline_mod_downward_net</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># NEUTRAL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Unclear signal → Use baseline batch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_baseline  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;OVERRIDE_neutral_net</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_trade</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>MEDIUM Confidence Blend</strong> (<code>prediction.py:246-283</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_execute_blended_decision</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    MEDIUM CONFIDENCE: Blend baseline signal with prediction signal</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate what baseline would do</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseline_action </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_get_baseline_action</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    direction </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;direction&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    net_benefit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pred_signal</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;net_benefit_pct&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Blend logic:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> baseline_action</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;triggered&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Baseline says SELL (price above threshold)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> direction </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;STRONG_UPWARD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MODERATE_UPWARD&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Predictions disagree (say hold) → reduce sell amount</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> baseline_action</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;batch_size&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;BLEND_reduce_sell_pred_upward_net</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Predictions agree or neutral → follow baseline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> baseline_action</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;batch_size&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;BLEND_follow_baseline_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">baseline_action</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&quot;reason&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Baseline says HOLD (price below threshold)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> direction </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;STRONG_DOWNWARD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;MODERATE_DOWNWARD&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Predictions disagree (say sell) → cautious sell</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_pred_cautious  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;BLEND_cautious_sell_pred_downward_net</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Predictions agree → hold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;BLEND_hold_pred_agrees&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_trade</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>LOW Confidence Baseline</strong> (<code>prediction.py:285-310</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_execute_baseline_logic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Execute IDENTICAL logic to PriceThresholdStrategy (for fair comparison)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    days_since_sale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last_sale_day</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate threshold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ma_30 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tail</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">30</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threshold </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ma_30 </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threshold_pct</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        threshold </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threshold_pct</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    signal_triggered </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price greater than threshold</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> signal_triggered</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Fallback after 60 days</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> days_since_sale greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_days_without_sale</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_trade</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_baseline</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;BASELINE_fallback_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">days_since_sale</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">d&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">               </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;BASELINE_below_threshold_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">current_price</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">threshold</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Signal triggered → analyze with technical indicators</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_analyze_baseline_technicals</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_execute_trade</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;BASELINE_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">reason</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>Example Execution</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 80:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Current price = $2.05/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MA = $1.95/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Threshold = $2.0475/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Predictions (2,000 paths × 14 days):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Day 14 median = $2.15/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Day 14 std dev = $0.06/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CV = $0.06 / $2.15 = 0.028 = 2.8% → HIGH CONFIDENCE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Calculate net benefit:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Best day to sell = Day 14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EV(day 14) = $2.15 - storage($0.08) - transaction($0.02) = $2.05</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    EV(today) = $2.05 - transaction($0.02) = $2.03</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Net benefit = ($2.05 - $2.03) / $2.05 × 100 = 0.98%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Signal analysis:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Confidence = HIGH (CV 2.8% &lt; 5%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Direction = MODERATE_UPWARD (net benefit 0.98% greater than 0.5%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Decision: HIGH CONFIDENCE → OVERRIDE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Direction = MODERATE_UPWARD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Batch size = 0.15 (small hedge)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Reason = &quot;OVERRIDE_small_hedge_mod_upward_net0.98%_cv2.8%&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Inventory = 40 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Sell 40 × 0.15 = 6 tons</span><br></span></code></pre></div></div>
<p><strong>Academic References</strong>:</p>
<ul>
<li class=""><strong>Marshall et al. (2008)</strong> for baseline threshold strategy</li>
<li class=""><strong>Williams &amp; Wright (1991)</strong> <em>Storage and Commodity Markets</em> for cost-benefit framework</li>
<li class="">Confidence weighting described as &quot;novel extension&quot;</li>
</ul>
<p><strong>Parameters</strong>:</p>
<ul>
<li class="">Inherits all baseline parameters from PriceThresholdStrategy</li>
<li class=""><code>high_confidence_cv</code>: 0.05 (5%)</li>
<li class=""><code>medium_confidence_cv</code>: 0.15 (15%)</li>
<li class="">`strong_positive_threshold: 2.0 (text: greater than 2 percent net benefit)</li>
<li class="">`strong_negative_threshold: -1.0 (text: less than -1 percent net benefit)</li>
<li class="">`moderate_threshold: 0.5 (text: plus or minus 0.5 percent)</li>
<li class=""><code>batch_pred_hold</code>: 0.0</li>
<li class=""><code>batch_pred_aggressive</code>: 0.40</li>
<li class=""><code>batch_pred_cautious</code>: 0.15</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="6-moving-average-predictive-matched-pair">6. Moving Average Predictive (Matched Pair)<a href="#6-moving-average-predictive-matched-pair" class="hash-link" aria-label="Direct link to 6. Moving Average Predictive (Matched Pair)" title="Direct link to 6. Moving Average Predictive (Matched Pair)" translate="no">​</a></h3>
<p><strong>File</strong>: <code>prediction.py:387-729</code></p>
<p><strong>Purpose</strong>: Augment Moving Average baseline with forecast-driven overrides.</p>
<p><strong>Same 3-tier confidence system</strong> as Price Threshold Predictive, but baseline is MA crossover instead of price threshold.</p>
<p><strong>Decision Logic</strong>: Identical structure to Price Threshold Predictive, but <code>_execute_baseline_logic()</code> implements MA crossover detection.</p>
<p><strong>Academic References</strong>: Same as Price Threshold Predictive.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="7-expected-value-strategy-standalone">7. Expected Value Strategy (Standalone)<a href="#7-expected-value-strategy-standalone" class="hash-link" aria-label="Direct link to 7. Expected Value Strategy (Standalone)" title="Direct link to 7. Expected Value Strategy (Standalone)" translate="no">​</a></h3>
<p><strong>File</strong>: <code>prediction.py:736-866</code></p>
<p><strong>Purpose</strong>: Optimize expected value across all forecast horizons.</p>
<p><strong>Algorithm</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. For each of 14 forecast days:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   a. Calculate expected revenue = median(predictions) - costs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. Find day with maximum expected value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. Calculate net benefit vs selling today</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. Decision based on:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Net benefit magnitude</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Prediction confidence (CV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Trend strength (ADX)</span><br></span></code></pre></div></div>
<p><strong>Optimal Sale Day Calculation</strong> (<code>prediction.py:841-857</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_find_optimal_sale_day_pct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># predictions is (2000 paths × 14 days)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ev_by_day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> day </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Use median of 2,000 paths as expected price</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">median</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        days_to_wait </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> day </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate costs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        storage_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_cost_pct_per_day </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> days_to_wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        transaction_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> future_price </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_cost_pct </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Expected value if we sell on this day</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> future_price </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> storage_cost </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> transaction_cost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ev_by_day</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ev</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Compare to selling today</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transaction_cost_today </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_cost_pct </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ev_today </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_price </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> transaction_cost_today</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Find best option</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimal_day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">argmax</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ev_by_day</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    net_benefit_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ev_by_day</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">optimal_day</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ev_today</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> current_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> optimal_day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net_benefit_pct</span><br></span></code></pre></div></div>
<p><strong>Decision Based on Net Benefit</strong> (<code>prediction.py:805-839</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_analyze_expected_value_pct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimal_day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net_benefit_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_find_optimal_sale_day_pct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate confidence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_prediction_confidence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> horizon_day</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Day 14</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    adx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_adx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> period</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Decision based on net benefit magnitude</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> net_benefit_pct greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min_net_benefit_pct</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># greater than 0.5%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Positive net benefit (waiting is better)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">high_confidence_cv </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> adx greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strong_trend_adx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># High confidence + strong trend - hold all</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_positive_confident  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;net_benefit_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_high_conf_hold_to_day</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">optimal_day</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">medium_confidence_cv</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Medium confidence - small hedge</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_positive_uncertain  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;net_benefit_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_med_conf_small_hedge_day</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">optimal_day</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Low confidence - larger hedge</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_marginal  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;net_benefit_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_low_conf_hedge&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> net_benefit_pct greater than </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Marginal benefit (0% to 0.5%)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_marginal  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;marginal_benefit_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_gradual_liquidation&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> net_benefit_pct greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">negative_threshold_pct</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># -0.3% to 0%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Mild negative (sell today slightly better)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_negative_mild  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;mild_negative_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_avoid_storage&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># less than -0.3%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Strong negative (sell immediately much better)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_negative_strong  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.35</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;strong_negative_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_sell_to_cut_losses&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><br></span></code></pre></div></div>
<p><strong>Example Calculation</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Current price: $2.00/lb = $4,000/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Inventory: 50 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Predictions (2,000 paths × 14 days):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 1:  Median = $2.01/lb = $4,020/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 7:  Median = $2.05/lb = $4,100/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 14: Median = $2.08/lb = $4,160/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Calculate EV for each day:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Future price: $4,020/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Storage cost: $4,000 × (0.005/100) × 1 = $0.20/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Transaction cost: $4,020 × (0.01/100) = $0.40/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  EV = $4,020 - $0.20 - $0.40 = $4,019.40/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 7:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Future price: $4,100/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Storage cost: $4,000 × (0.005/100) × 7 = $1.40/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Transaction cost: $4,100 × (0.01/100) = $0.41/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  EV = $4,100 - $1.40 - $0.41 = $4,098.19/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 14:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Future price: $4,160/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Storage cost: $4,000 × (0.005/100) × 14 = $2.80/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Transaction cost: $4,160 × (0.01/100) = $0.42/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  EV = $4,160 - $2.80 - $0.42 = $4,156.78/ton  ← BEST</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Sell today:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Price: $4,000/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Transaction cost: $4,000 × (0.01/100) = $0.40/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  EV = $4,000 - $0.40 = $3,999.60/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net benefit = ($4,156.78 - $3,999.60) / $4,000 × 100 = 3.93%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Confidence:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CV at day 14 = 0.04 = 4% → HIGH CONFIDENCE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ADX = 30 → STRONG TREND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Decision:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Net benefit = 3.93% greater than 0.5% (positive)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CV = 4% &lt; 5% (high confidence)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ADX = 30 greater than 25 (strong trend)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → batch_size = 0.0 (HOLD all)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → reason = &quot;net_benefit_3.93%_high_conf_hold_to_day14&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Result: HOLD all 50 tons (wait for day 14)</span><br></span></code></pre></div></div>
<p><strong>Academic References</strong>:</p>
<ul>
<li class=""><strong>Williams, J. C., &amp; Wright, B. D. (1991).</strong> <em>Storage and Commodity Markets.</em> Cambridge University Press.<!-- -->
<ul>
<li class="">ISBN: 9780521326162</li>
<li class="">Comprehensive treatment of commodity storage decisions with uncertainty</li>
<li class="">PERFECT fit for this strategy</li>
</ul>
</li>
</ul>
<p><strong>Parameters</strong>:</p>
<ul>
<li class=""><code>storage_cost_pct_per_day</code>: Inherited from config</li>
<li class=""><code>transaction_cost_pct</code>: Inherited from config</li>
<li class=""><code>min_net_benefit_pct</code>: 0.5 (0.5% minimum)</li>
<li class=""><code>negative_threshold_pct</code>: -0.3 (-0.3%)</li>
<li class=""><code>high_confidence_cv</code>: 0.05 (5%)</li>
<li class=""><code>medium_confidence_cv</code>: 0.10 (10%)</li>
<li class=""><code>strong_trend_adx</code>: 25</li>
<li class=""><code>batch_positive_confident</code>: 0.0</li>
<li class=""><code>batch_positive_uncertain</code>: 0.10</li>
<li class=""><code>batch_marginal</code>: 0.15</li>
<li class=""><code>batch_negative_mild</code>: 0.25</li>
<li class=""><code>batch_negative_strong</code>: 0.35</li>
<li class=""><code>cooldown_days</code>: 7</li>
<li class=""><code>baseline_batch</code>: 0.15</li>
<li class=""><code>baseline_frequency</code>: 30</li>
</ul>
<p><strong>Why this design?</strong>:</p>
<ul>
<li class="">Academically grounded (Williams &amp; Wright 1991)</li>
<li class="">Optimal from cost-benefit perspective</li>
<li class="">Accounts for storage costs rising linearly with time</li>
<li class="">Uses ensemble median (robust to outliers)</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="8-consensus-strategy-standalone">8. Consensus Strategy (Standalone)<a href="#8-consensus-strategy-standalone" class="hash-link" aria-label="Direct link to 8. Consensus Strategy (Standalone)" title="Direct link to 8. Consensus Strategy (Standalone)" translate="no">​</a></h3>
<p><strong>File</strong>: <code>prediction.py:873-1028</code></p>
<p><strong>Purpose</strong>: Democratic vote across 2,000 forecast paths.</p>
<p><strong>Algorithm</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. Count % of paths showing sufficient return (greater than 3%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. If ≥70% bullish AND net benefit greater than threshold: HOLD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. If &lt;30% bullish (bearish consensus): SELL aggressively</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. Batch size modulated by consensus strength</span><br></span></code></pre></div></div>
<p><strong>Consensus Calculation</strong> (<code>prediction.py:963-1019</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_analyze_consensus_pct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Evaluate at day 14</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eval_day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">evaluation_day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    day_predictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eval_day</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2,000 values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate expected return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    median_future </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">median</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day_predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expected_return_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">median_future </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> current_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Count bullish predictions (those showing greater than 3% return)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bullish_count </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">sum</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day_predictions </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> current_price greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min_return  </span><span class="token comment" style="color:#999988;font-style:italic"># 3%</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bullish_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bullish_count </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day_predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0 to 1.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate confidence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_prediction_confidence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eval_day</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate net benefit (accounting for costs)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    days_to_wait </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> eval_day </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_cost_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_cost_pct_per_day </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> days_to_wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transaction_cost_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_cost_pct </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    net_benefit_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expected_return_pct </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> storage_cost_pct </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> transaction_cost_pct</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Decision based on consensus strength</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> bullish_pct greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">very_strong_consensus </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> net_benefit_pct greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min_net_benefit_pct</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Very strong consensus (85%+ bullish) + positive net benefit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_strong_consensus  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;very_strong_consensus_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">bullish_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_net_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_hold&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> bullish_pct greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consensus_threshold </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> net_benefit_pct greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min_net_benefit_pct</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Strong consensus (70%+ bullish) + positive net benefit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">high_confidence_cv</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_strong_consensus  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;strong_consensus_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">bullish_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_high_conf_hold&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_moderate  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;strong_consensus_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">bullish_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_med_conf_gradual&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> bullish_pct greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">moderate_consensus</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Moderate consensus (60%+ bullish)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_moderate  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.15</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;moderate_consensus_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">bullish_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_gradual&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> bullish_pct </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">consensus_threshold</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Bearish consensus (&lt; 30% bullish, i.e., greater than 70% bearish)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_bearish  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.35</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;bearish_consensus_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">bullish_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_sell&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Weak/unclear consensus (30-60% bullish)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_weak  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;weak_consensus_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">bullish_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.0%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_sell&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><br></span></code></pre></div></div>
<p><strong>Example</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Predictions at day 14: 2,000 paths</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Current price: $2.00/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path-by-path analysis:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path 1: $2.08/lb → Return = 4.0% → BULLISH (greater than 3%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path 2: $2.05/lb → Return = 2.5% → BEARISH (&lt; 3%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path 3: $2.10/lb → Return = 5.0% → BULLISH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path 4: $2.02/lb → Return = 1.0% → BEARISH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Path 2000: $2.07/lb → Return = 3.5% → BULLISH</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Count:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bullish paths: 1,700</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bearish paths: 300</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bullish percentage: 1,700 / 2,000 = 85%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Statistics:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Median = $2.08/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Std dev = $0.06/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">CV = $0.06 / $2.08 = 0.029 = 2.9% → HIGH CONFIDENCE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Expected return = ($2.08 - $2.00) / $2.00 = 4.0%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Storage cost (14 days) = 0.005% × 14 = 0.07%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Transaction cost = 0.01%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net benefit = 4.0% - 0.07% - 0.01% = 3.92%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Decision:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Bullish% = 85% greater than or equal to  85% (very strong consensus)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Net benefit = 3.92% greater than 0.5%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">→ batch_size = 0.0 (HOLD all)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">→ reason = &quot;very_strong_consensus_85%_net_3.92%_hold&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Result: HOLD all inventory</span><br></span></code></pre></div></div>
<p><strong>Academic References</strong>:</p>
<ul>
<li class=""><strong>Clemen, R. T. (1989).</strong> &quot;Combining forecasts: A review and annotated bibliography.&quot; <em>International Journal of Forecasting</em>, 5(4), 559-583.<!-- -->
<ul>
<li class="">DOI: 10.1016/0169-2070(89)90012-5</li>
<li class="">2,165+ citations</li>
<li class="">Key finding: &quot;Forecast accuracy can be substantially improved through combination of multiple individual forecasts&quot;</li>
<li class="">EXCELLENT fit for ensemble/consensus methodology</li>
</ul>
</li>
</ul>
<p><strong>Parameters</strong>:</p>
<ul>
<li class=""><code>storage_cost_pct_per_day</code>: Inherited</li>
<li class=""><code>transaction_cost_pct</code>: Inherited</li>
<li class=""><code>consensus_threshold</code>: 0.70 (70% agreement)</li>
<li class=""><code>very_strong_consensus</code>: 0.85 (85% agreement)</li>
<li class=""><code>moderate_consensus</code>: 0.60 (60% agreement)</li>
<li class=""><code>min_return</code>: 0.03 (3% return threshold for &quot;bullish&quot;)</li>
<li class=""><code>min_net_benefit_pct</code>: 0.5 (0.5% minimum)</li>
<li class=""><code>high_confidence_cv</code>: 0.05 (5%)</li>
<li class=""><code>evaluation_day</code>: 14</li>
<li class=""><code>batch_strong_consensus</code>: 0.0</li>
<li class=""><code>batch_moderate</code>: 0.15</li>
<li class=""><code>batch_weak</code>: 0.25</li>
<li class=""><code>batch_bearish</code>: 0.35</li>
<li class=""><code>cooldown_days</code>: 7</li>
</ul>
<p><strong>Why this design?</strong>:</p>
<ul>
<li class="">Ensemble voting robust to individual model errors</li>
<li class="">Leverages full distribution (not just median)</li>
<li class="">Captures market uncertainty through consensus strength</li>
<li class="">Democratic approach reduces impact of outliers</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="9-risk-adjusted-strategy-standalone">9. Risk-Adjusted Strategy (Standalone)<a href="#9-risk-adjusted-strategy-standalone" class="hash-link" aria-label="Direct link to 9. Risk-Adjusted Strategy (Standalone)" title="Direct link to 9. Risk-Adjusted Strategy (Standalone)" translate="no">​</a></h3>
<p><strong>File</strong>: <code>prediction.py:1035-1190</code></p>
<p><strong>Purpose</strong>: Balance expected return vs forecast uncertainty (Sharpe ratio approach).</p>
<p><strong>Algorithm</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. Calculate expected return as percentage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. Measure prediction uncertainty (CV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. Classify into risk tiers:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Low risk (CV &lt; 5% + strong trend): HOLD all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Medium risk (CV &lt; 10%): Small hedge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - High risk (CV &lt; 20%): Larger hedge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Very high risk (CV ≥ 20%): Sell aggressively</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. Decision based on return/risk tradeoff</span><br></span></code></pre></div></div>
<p><strong>Risk-Adjusted Decision</strong> (<code>prediction.py:1125-1181</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_analyze_risk_adjusted_pct</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Evaluate at day 14</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eval_day </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">evaluation_day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    day_predictions </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eval_day</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2,000 values</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate expected return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    median_future </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">median</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">day_predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    expected_return_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">median_future </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> current_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Measure uncertainty (risk)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_prediction_confidence</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eval_day</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># cv = std_dev / median</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Low risk: cv &lt; 0.05 (5%)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Medium risk: cv &lt; 0.10 (10%)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># High risk: cv &lt; 0.20 (20%)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Very high risk: cv greater than or equal to  0.20</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Calculate net benefit (accounting for costs)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    days_to_wait </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> eval_day </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_cost_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_cost_pct_per_day </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> days_to_wait</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    transaction_cost_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_cost_pct </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    net_benefit_pct </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">expected_return_pct </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> storage_cost_pct </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> transaction_cost_pct</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Get trend strength</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    adx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> _ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> calculate_adx</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> period</span><span class="token operator" style="color:#393A34">=</span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">14</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">price_history</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Check if return is sufficient</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> expected_return_pct greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min_return </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> net_benefit_pct greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">min_net_benefit_pct</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Sufficient return - tier by risk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_uncertainty_low </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> adx greater than self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strong_trend_adx</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Low risk + strong trend</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_low_risk  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;low_risk_cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_return</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">expected_return_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_hold&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_uncertainty_medium</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Medium risk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_medium_risk  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;medium_risk_cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_return</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">expected_return_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_small_hedge&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_uncertainty_high</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># High risk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_high_risk  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;high_risk_cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_return</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">expected_return_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_hedge&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Very high risk</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_very_high_risk  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.35</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;very_high_risk_cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">cv</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_sell&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Insufficient return or negative net benefit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> net_benefit_pct </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_very_high_risk  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.35</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;negative_net_benefit_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">net_benefit_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">%_sell&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">batch_high_risk  </span><span class="token comment" style="color:#999988;font-style:italic"># 0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;insufficient_return_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">expected_return_pct</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.2%</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_sell&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> batch_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reason</span><br></span></code></pre></div></div>
<p><strong>Risk-Tiered Examples</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Scenario A: Low Risk, High Return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Current price: $2.00/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Day 14 predictions (2,000 paths):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Median: $2.10/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Std dev: $0.06/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CV = $0.06 / $2.10 = 0.029 = 2.9% → LOW RISK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Expected return = ($2.10 - $2.00) / $2.00 = 5.0%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Net benefit = 5.0% - 0.07% - 0.01% = 4.92%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ADX = 30 → STRONG TREND</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Decision:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Expected return 5.0% greater than or equal to  3.0% ✓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Net benefit 4.92% greater than 0.5% ✓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CV 2.9% &lt; 5.0% → LOW RISK ✓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ADX 30 greater than 25 → STRONG TREND ✓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → batch_size = 0.0 (HOLD all)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → reason = &quot;low_risk_cv2.9%_return5.0%_hold&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scenario B: High Risk, High Return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Current price: $2.00/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Day 14 predictions (2,000 paths):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Median: $2.10/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Std dev: $0.38/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CV = $0.38 / $2.10 = 0.18 = 18% → HIGH RISK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Expected return = 5.0%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Net benefit = 4.92%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Decision:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Expected return 5.0% greater than or equal to  3.0% ✓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Net benefit 4.92% greater than 0.5% ✓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CV 18% &lt; 20% → HIGH RISK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → batch_size = 0.25 (hedge 25%)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → reason = &quot;high_risk_cv18%_return5.0%_hedge&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scenario C: Low Risk, Low Return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Current price: $2.00/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Day 14 predictions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Median: $2.04/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CV = 3% → LOW RISK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Expected return = ($2.04 - $2.00) / $2.00 = 2.0%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Net benefit = 2.0% - 0.07% - 0.01% = 1.92%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Decision:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Expected return 2.0% &lt; 3.0% ✗ (insufficient)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Net benefit 1.92% greater than 0.5% ✓ (positive but below threshold)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → batch_size = 0.25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → reason = &quot;insufficient_return_2.0%_sell&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Scenario D: High Risk, Low Return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Current price: $2.00/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Day 14 predictions:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Median: $2.04/lb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CV = 22% → VERY HIGH RISK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Expected return = 2.0%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Decision:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Expected return 2.0% &lt; 3.0% ✗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CV 22% greater than or equal to  20% → VERY HIGH RISK</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → batch_size = 0.35 (aggressive sell)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → reason = &quot;very_high_risk_cv22%_sell&quot;</span><br></span></code></pre></div></div>
<p><strong>Academic References</strong>:</p>
<ul>
<li class=""><strong>Markowitz, H. (1952).</strong> &quot;Portfolio selection.&quot; <em>Journal of Finance</em>, 7(1), 77-91.<!-- -->
<ul>
<li class="">DOI: 10.1111/j.1540-6261.1952.tb01525.x</li>
<li class="">5,254+ citations</li>
<li class="">Nobel Prize winner (1990)</li>
<li class="">PERFECT fit - strategy directly implements mean-variance optimization using CV for risk</li>
</ul>
</li>
</ul>
<p><strong>Parameters</strong>:</p>
<ul>
<li class=""><code>storage_cost_pct_per_day</code>: Inherited</li>
<li class=""><code>transaction_cost_pct</code>: Inherited</li>
<li class=""><code>min_return</code>: 0.03 (3% minimum return)</li>
<li class=""><code>min_net_benefit_pct</code>: 0.5 (0.5% minimum)</li>
<li class=""><code>max_uncertainty_low</code>: 0.05 (CV &lt; 5% = low risk)</li>
<li class=""><code>max_uncertainty_medium</code>: 0.10 (CV &lt; 10% = medium risk)</li>
<li class=""><code>max_uncertainty_high</code>: 0.20 (CV &lt; 20% = high risk)</li>
<li class=""><code>strong_trend_adx</code>: 25</li>
<li class=""><code>evaluation_day</code>: 14</li>
<li class=""><code>batch_low_risk</code>: 0.0</li>
<li class=""><code>batch_medium_risk</code>: 0.10</li>
<li class=""><code>batch_high_risk</code>: 0.25</li>
<li class=""><code>batch_very_high_risk</code>: 0.35</li>
<li class=""><code>cooldown_days</code>: 7</li>
</ul>
<p><strong>Why this design?</strong>:</p>
<ul>
<li class="">Implements Markowitz mean-variance framework</li>
<li class="">Risk-adjusted returns (similar to Sharpe ratio)</li>
<li class="">Balances greed (expected return) with fear (uncertainty)</li>
<li class="">CV provides scale-invariant risk measure</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="optimization-strategy">Optimization Strategy<a href="#optimization-strategy" class="hash-link" aria-label="Direct link to Optimization Strategy" title="Direct link to Optimization Strategy" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="10-rolling-horizon-mpc-model-predictive-control">10. Rolling Horizon MPC (Model Predictive Control)<a href="#10-rolling-horizon-mpc-model-predictive-control" class="hash-link" aria-label="Direct link to 10. Rolling Horizon MPC (Model Predictive Control)" title="Direct link to 10. Rolling Horizon MPC (Model Predictive Control)" translate="no">​</a></h3>
<p><strong>File</strong>: <code>rolling_horizon_mpc.py:39-290</code></p>
<p><strong>Purpose</strong>: Optimal control with limited foresight using linear programming.</p>
<p><strong>Key Concept: Receding Horizon Control</strong></p>
<p>Traditional optimization problem:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Given: Full price trajectory for 365 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Find: Optimal sell schedule for all 365 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Problem: We don&#x27;t have perfect foresight!</span><br></span></code></pre></div></div>
<p>Rolling Horizon MPC:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 0: See prices for days 1-14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Solve optimization for days 1-14</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Execute ONLY day 1 decision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 1: See prices for days 2-15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Solve optimization for days 2-15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       Execute ONLY day 2 decision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">... roll forward daily</span><br></span></code></pre></div></div>
<p><strong>Decision Logic</strong> (<code>rolling_horizon_mpc.py:77-179</code>):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">decide</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_price</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> price_history</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> predictions</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Solve 14-day local optimization, execute first decision only.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> inventory less than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;no_inventory&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> predictions </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;no_predictions&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Get forecast window (14 days)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># predictions is (2000 paths, 14 days) matrix</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        available_horizon </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># predictions is 1D array (single path)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        available_horizon </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    window_len </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">horizon_days</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> available_horizon</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># min(14, available)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> window_len less than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;SELL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;no_forecast_horizon&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Get predicted prices for the window (use mean of 2,000 paths)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future_prices_cents </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">window_len</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">axis</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future_prices_cents </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">window_len</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Convert cents/lb to $/ton</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    future_prices_per_ton </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> future_prices_cents </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">20</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2000 lbs = 1 ton</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Future harvest (zeros - BacktestEngine handles harvest externally)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    future_harvest </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zeros</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">window_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Solve local LP for this window</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_solve_window_lp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        current_inventory</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future_prices</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">future_prices_per_ton</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        future_harvest</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">future_harvest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;sell_solution&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;lp_failed&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># EXECUTE ONLY THE FIRST DECISION (Receding Horizon)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sell_today </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;sell_solution&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Update shadow price if using shadow pricing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shadow_price_smoothing </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;shadow_price&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smoothed_shadow_price </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smoothed_shadow_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;shadow_price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Exponential smoothing</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            alpha </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shadow_price_smoothing</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smoothed_shadow_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">alpha </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;shadow_price&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> alpha</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smoothed_shadow_price</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Threshold to avoid tiny sales</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> sell_today </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;HOLD&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;mpc_hold&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Sell amount (capped at current inventory)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sell_amount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">min</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sell_today</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;SELL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sell_amount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;mpc_optimize&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;window_len&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> window_len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;predicted_net_value&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;objective_value&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>Linear Programming Formulation</strong> (<code>rolling_horizon_mpc.py:181-290</code>):</p>
<p><strong>Decision Variables</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">sell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Amount to sell each day</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># Inventory at end of each day</span><br></span></code></pre></div></div>
<p>Total: 28 variables (14 sell + 14 inventory)</p>
<p><strong>Objective Function</strong> (maximize profit):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Revenue - Transaction Costs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">revenue </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Σ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> × price</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> × </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> transaction_cost</span><span class="token operator" style="color:#393A34">%</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Storage Costs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">storage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Σ</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> × price</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> × storage_cost_pct_per_day</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Objective: maximize revenue - storage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">objective </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> revenue </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># LP minimizes, so negate</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">minimize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">revenue </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> storage</span><br></span></code></pre></div></div>
<p><strong>Constraints</strong> (inventory balance):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># For each day t:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># sell[t] + inv[t] - inv[t-1] = harvest[t]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_inventory </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> harvest</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> harvest</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> harvest</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day </span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> harvest</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p><strong>Bounds</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sell</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin">all</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">   </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token builtin">all</span><span class="token plain"> t</span><br></span></code></pre></div></div>
<p><strong>LP Solve Implementation</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_solve_window_lp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> current_inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> future_prices</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> future_harvest</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Solve the local LP optimization for the forecast window.</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        current_inventory: Starting inventory (tons)</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        future_prices: Array of predicted prices ($/ton) for 14 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        future_harvest: Array of harvest increments (tons) for 14 days</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        Dict with sell_solution, inventory_solution, objective_value, shadow_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_days </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">future_prices</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 14</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Decision variables: [sell[0], ..., sell[13], inv[0], ..., inv[13]]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var_sell_start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var_inv_start </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> n_days</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Objective function coefficients</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zeros</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> n_days</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 28 variables</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Revenue (negative because we minimize)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    revenue_coeff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> future_prices </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transaction_cost_pct </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">var_sell_start</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">var_inv_start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">revenue_coeff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Storage costs (positive)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage_coeff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> future_prices </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">storage_cost_pct_per_day </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">var_inv_start</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> storage_coeff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Constraints: A_eq * x = b_eq</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    A_eq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b_eq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> t </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">n_days</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        row </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">zeros</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> n_days</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Inventory balance: sell[t] + inv[t] - inv[t-1] = harvest[t]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        row</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">var_sell_start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># sell[t]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        row</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">var_inv_start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># inv[t]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> t greater than </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            row</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">var_inv_start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> t </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># inv[t-1]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">future_harvest</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Day 0: sell[0] + inv[0] = current_inventory + harvest[0]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">current_inventory </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> future_harvest</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">t</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        A_eq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">row</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    A_eq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">A_eq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    b_eq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b_eq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># CRITICAL: Add terminal value to objective</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># This prevents End-of-Horizon effect (myopic liquidation)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shadow_price_smoothing </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smoothed_shadow_price </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Use smoothed shadow price as terminal value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        terminal_val_coeff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">smoothed_shadow_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">var_inv_start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> n_days </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> terminal_val_coeff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Use simple price-based terminal value with decay</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        terminal_val_coeff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">future_prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">terminal_value_decay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">var_inv_start </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> n_days </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> terminal_val_coeff</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Bounds: all variables greater than or equal to  0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bounds </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> _ </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> n_days</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Solve LP using scipy.optimize.linprog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> linprog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            c</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            A_eq</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">A_eq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            b_eq</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">b_eq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            bounds</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">bounds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            method</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;highs&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            options</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;disp&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;presolve&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Extract solution</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sell_solution </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">var_sell_start</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">var_inv_start</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inv_solution </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">var_inv_start</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Extract shadow price (approximate)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        shadow_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> future_prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">terminal_value_decay</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;sell_solution&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> sell_solution</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;inventory_solution&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inv_solution</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;objective_value&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fun</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Negate back to profit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;shadow_price&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> shadow_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> Exception </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Rolling Horizon LP failed: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><br></span></code></pre></div></div>
<p><strong>Critical: Terminal Value Correction</strong></p>
<p><strong>Problem</strong>: Without terminal value, LP liquidates everything by day 14 (myopic).</p>
<p><strong>Why?</strong></p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 14 inventory has zero value in objective</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">LP thinks: &quot;Sell everything by day 14, inventory is worthless after&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Result: Suboptimal early liquidation</span><br></span></code></pre></div></div>
<p><strong>Solution</strong>: Add terminal value to inventory remaining at day 14.</p>
<p><strong>Simple approach</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Use future price with decay</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">terminal_value_coeff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">future_prices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> × </span><span class="token number" style="color:#36acaa">0.95</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 95% of day 14 price</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> terminal_value_coeff  </span><span class="token comment" style="color:#999988;font-style:italic"># Add to objective</span><br></span></code></pre></div></div>
<p><strong>Advanced approach</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Use shadow prices (smoothed dual variable from previous LP solves)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> shadow_price_smoothing</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    terminal_value_coeff </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">smoothed_shadow_price</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    c</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">inv</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">13</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> terminal_value_coeff</span><br></span></code></pre></div></div>
<p><strong>Example Execution</strong>:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Current inventory: 50 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Forecast (2,000 paths × 14 days):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mean prices = [4000, 4020, 4040, ..., 4280] $/ton</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LP setup:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Variables: [sell[0], ..., sell[13], inv[0], ..., inv[13]]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Objective:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Revenue = sell[0]×4000 + sell[1]×4020 + ... + sell[13]×4280</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Transaction costs = sell[0]×40 + sell[1]×40.2 + ... + sell[13]×42.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Storage costs = inv[0]×0.2 + inv[1]×0.201 + ... + inv[13]×0.214</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Terminal value = inv[13] × 4280 × 0.95 = inv[13] × 4066</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Constraints:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sell[0] + inv[0] = 50</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sell[1] + inv[1] - inv[0] = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      sell[13] + inv[13] - inv[12] = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Bounds:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      All variables greater than or equal to  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LP solves:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sell = [5.2, 4.8, 6.1, ..., 3.1] tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inv = [44.8, 40.0, 33.9, ..., 8.5] tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    objective = $195,432</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Execute ONLY sell[0] = 5.2 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 1:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Current inventory: 50 - 5.2 = 44.8 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Forecast (new 14-day window):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Mean prices = [4020, 4040, 4060, ..., 4300] $/ton (updated!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LP solves again with new prices:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sell = [3.9, 5.2, 4.7, ..., 2.8] tons  (different from yesterday!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Execute ONLY sell[0] = 3.9 tons</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">... continues rolling forward</span><br></span></code></pre></div></div>
<p><strong>Academic References</strong>:</p>
<ul>
<li class=""><strong>Secomandi, N. (2010).</strong> &quot;Optimal Commodity Trading with a Capacitated Storage Asset.&quot; <em>Management Science</em>, 56(3), 449-467.<!-- -->
<ul>
<li class="">DOI: 10.1287/mnsc.1090.1049</li>
<li class="">Carnegie Mellon University</li>
<li class="">Addresses warehouse problem with finite horizons and terminal boundary conditions</li>
<li class="">Optimal inventory-trading policy with stage-dependent basestock targets</li>
<li class="">BEST match for MPC approach</li>
</ul>
</li>
<li class=""><strong>Williams, J. C., &amp; Wright, B. D. (1991).</strong> <em>Storage and Commodity Markets.</em>
<ul>
<li class="">Alternative citation for agricultural commodity storage framework</li>
</ul>
</li>
</ul>
<p><strong>Parameters</strong>:</p>
<ul>
<li class=""><code>storage_cost_pct_per_day</code>: 0.3% (default for MPC)</li>
<li class=""><code>transaction_cost_pct</code>: 2.0% (default for MPC)</li>
<li class=""><code>horizon_days</code>: 14</li>
<li class=""><code>terminal_value_decay</code>: 0.95 (95% of day 14 price)</li>
<li class=""><code>shadow_price_smoothing</code>: None (simple) or 0.3 (advanced)</li>
</ul>
<p><strong>Why this design?</strong>:</p>
<ul>
<li class="">Academically grounded (Secomandi 2010, Williams &amp; Wright 1991)</li>
<li class="">Optimal given limited foresight</li>
<li class="">Terminal value prevents myopic liquidation</li>
<li class="">Expected performance: 85-95% of Oracle (perfect foresight)</li>
<li class="">Mimics Model Predictive Control from control theory</li>
</ul>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="academic-references">Academic References<a href="#academic-references" class="hash-link" aria-label="Direct link to Academic References" title="Direct link to Academic References" translate="no">​</a></h2>
<p>Complete bibliography with all citations.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="core-citations-high-impact">Core Citations (High Impact)<a href="#core-citations-high-impact" class="hash-link" aria-label="Direct link to Core Citations (High Impact)" title="Direct link to Core Citations (High Impact)" translate="no">​</a></h3>
<p><strong>1. Markowitz, H. (1952).</strong> Portfolio selection. <em>Journal of Finance</em>, 7(1), 77-91.</p>
<ul>
<li class=""><strong>DOI</strong>: 10.1111/j.1540-6261.1952.tb01525.x</li>
<li class=""><strong>Citations</strong>: 5,254+</li>
<li class=""><strong>Notes</strong>: Nobel Prize winner (1990). Foundation of mean-variance optimization and modern portfolio theory.</li>
<li class=""><strong>Use for</strong>: Risk-Adjusted strategy (PERFECT fit)</li>
</ul>
<p><strong>2. Williams, J. C., &amp; Wright, B. D. (1991).</strong> <em>Storage and commodity markets.</em> Cambridge University Press.</p>
<ul>
<li class=""><strong>ISBN</strong>: 9780521326162</li>
<li class=""><strong>Pages</strong>: 502</li>
<li class=""><strong>Notes</strong>: Comprehensive treatment of commodity storage with uncertainty. Economic Journal: &quot;Of major significance in the analysis of commodity markets.&quot;</li>
<li class=""><strong>Use for</strong>: Expected Value strategy, Rolling Horizon MPC strategy</li>
</ul>
<p><strong>3. Marshall, B. R., Cahan, R. H., &amp; Cahan, J. M. (2008).</strong> Can commodity futures be profitably traded with quantitative market timing strategies? <em>Journal of Banking &amp; Finance</em>, 32(9), 1810-1819.</p>
<ul>
<li class=""><strong>Notes</strong>: Comprehensive examination of quantitative trading rules in commodity futures. Tests 15 major commodity futures series.</li>
<li class=""><strong>Use for</strong>: Price Threshold, Moving Average, and their predictive variants</li>
</ul>
<p><strong>4. Clemen, R. T. (1989).</strong> Combining forecasts: A review and annotated bibliography. <em>International Journal of Forecasting</em>, 5(4), 559-583.</p>
<ul>
<li class=""><strong>DOI</strong>: 10.1016/0169-2070(89)90012-5</li>
<li class=""><strong>Citations</strong>: 2,165+</li>
<li class=""><strong>Notes</strong>: Comprehensive review with 200+ item annotated bibliography. Key finding: &quot;Forecast accuracy can be substantially improved through combination.&quot;</li>
<li class=""><strong>Use for</strong>: Consensus strategy</li>
</ul>
<p><strong>5. Wilder, J. Welles (1978).</strong> <em>New concepts in technical trading systems.</em> Trend Research.</p>
<ul>
<li class=""><strong>Pages</strong>: 142</li>
<li class=""><strong>Notes</strong>: Original source for RSI, ADX, Parabolic SAR, ATR. Considered one of the most innovative books on technical analysis.</li>
<li class=""><strong>Use for</strong>: Price Threshold and Moving Average strategies (technical indicators)</li>
</ul>
<p><strong>6. Brock, W., Lakonishok, J., &amp; LeBaron, B. (1992).</strong> Simple technical trading rules and the stochastic properties of stock returns. <em>Journal of Finance</em>, 47(5), 1731-1764.</p>
<ul>
<li class=""><strong>DOI</strong>: 10.1111/j.1540-6261.1992.tb04681.x</li>
<li class=""><strong>Citations</strong>: 2,200+</li>
<li class=""><strong>Notes</strong>: Highly cited empirical study of technical trading rules. Validates MA strategies.</li>
<li class=""><strong>Use for</strong>: Moving Average strategy (optional - academic validation)</li>
</ul>
<p><strong>7. Secomandi, N. (2010).</strong> Optimal commodity trading with a capacitated storage asset. <em>Management Science</em>, 56(3), 449-467.</p>
<ul>
<li class=""><strong>DOI</strong>: 10.1287/mnsc.1090.1049</li>
<li class=""><strong>Author</strong>: Tepper School of Business, Carnegie Mellon University</li>
<li class=""><strong>Notes</strong>: Finite horizon dynamic programming for commodity storage. Stage-dependent basestock policies.</li>
<li class=""><strong>Use for</strong>: Rolling Horizon MPC strategy</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="strategy-to-citation-mapping">Strategy-to-Citation Mapping<a href="#strategy-to-citation-mapping" class="hash-link" aria-label="Direct link to Strategy-to-Citation Mapping" title="Direct link to Strategy-to-Citation Mapping" translate="no">​</a></h3>
<table><thead><tr><th>#</th><th>Strategy</th><th>Primary Citation(s)</th><th>Quality</th></tr></thead><tbody><tr><td>1</td><td>Immediate Sale</td><td>None (naive baseline)</td><td>N/A</td></tr><tr><td>2</td><td>Equal Batches</td><td>None found</td><td>⚠️ Heuristic only</td></tr><tr><td>3</td><td>Price Threshold</td><td>Marshall et al. (2008) + Wilder (1978)</td><td>✅ VERIFIED</td></tr><tr><td>4</td><td>Moving Average</td><td>Marshall et al. (2008) + Wilder (1978)</td><td>✅ VERIFIED</td></tr><tr><td>5</td><td>Threshold Predictive</td><td>Marshall (2008) + Williams &amp; Wright (1991)</td><td>✅ VERIFIED</td></tr><tr><td>6</td><td>MA Predictive</td><td>Marshall (2008) + Williams &amp; Wright (1991)</td><td>✅ VERIFIED</td></tr><tr><td>7</td><td>Expected Value</td><td>Williams &amp; Wright (1991)</td><td>✅ VERIFIED</td></tr><tr><td>8</td><td>Consensus</td><td>Clemen (1989)</td><td>✅ VERIFIED</td></tr><tr><td>9</td><td>Risk-Adjusted</td><td>Markowitz (1952)</td><td>✅ PERFECT ⭐</td></tr><tr><td>10</td><td>Rolling Horizon MPC</td><td>Secomandi (2010) or Williams &amp; Wright (1991)</td><td>✅ VERIFIED</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="design-decisions">Design Decisions<a href="#design-decisions" class="hash-link" aria-label="Direct link to Design Decisions" title="Direct link to Design Decisions" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-3-tier-prediction-system">Why 3-Tier Prediction System?<a href="#why-3-tier-prediction-system" class="hash-link" aria-label="Direct link to Why 3-Tier Prediction System?" title="Direct link to Why 3-Tier Prediction System?" translate="no">​</a></h3>
<p><strong>Problem</strong>: How to use forecasts when confidence varies?</p>
<p><strong>Bad Approach</strong>: Always follow predictions</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> predicted_price greater than current_price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> HOLD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> SELL</span><br></span></code></pre></div></div>
<p>Problem: When CV = 30% (very uncertain), predictions are unreliable.</p>
<p><strong>Good Approach</strong>: Confidence-based blending</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.05</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># HIGH confidence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Override baseline completely</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> predicted_upward</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> HOLD</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">elif</span><span class="token plain"> cv </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.15</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># MEDIUM confidence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Blend baseline + predictions</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> baseline_sell </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> predicted_upward</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> SELL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">amount </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Reduce baseline action</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># LOW confidence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Ignore predictions, use baseline</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> baseline_decision</span><br></span></code></pre></div></div>
<p><strong>Result</strong>: Fair matched-pair comparison shows value of predictions.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-coefficient-of-variation-cv">Why Coefficient of Variation (CV)?<a href="#why-coefficient-of-variation-cv" class="hash-link" aria-label="Direct link to Why Coefficient of Variation (CV)?" title="Direct link to Why Coefficient of Variation (CV)?" translate="no">​</a></h3>
<p><strong>CV = std_dev / median</strong></p>
<p><strong>Benefits</strong>:</p>
<ol>
<li class=""><strong>Scale-invariant</strong>: Works for $1/lb or $100/lb prices</li>
<li class=""><strong>Relative uncertainty</strong>: 5% CV on $2.00 price = $0.10 std dev</li>
<li class=""><strong>Industry standard</strong>: Forecast evaluation metric</li>
</ol>
<p><strong>Alternative (worse)</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">uncertainty </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> std_dev  </span><span class="token comment" style="color:#999988;font-style:italic"># Absolute dollars</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Problem: $0.10 std dev is high for $1.00 price, low for $10.00 price</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-median-instead-of-mean">Why Median Instead of Mean?<a href="#why-median-instead-of-mean" class="hash-link" aria-label="Direct link to Why Median Instead of Mean?" title="Direct link to Why Median Instead of Mean?" translate="no">​</a></h3>
<p><strong>Forecast ensemble</strong>: 2,000 price paths</p>
<p><strong>Mean</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mean_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Sensitive to outliers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># If 1 path predicts $100, mean shifts significantly</span><br></span></code></pre></div></div>
<p><strong>Median</strong>:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">median_price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">median</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">predictions</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Robust to outliers</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Outliers don&#x27;t affect median</span><br></span></code></pre></div></div>
<p><strong>Result</strong>: Median is more stable and robust.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-14-day-horizon">Why 14-Day Horizon?<a href="#why-14-day-horizon" class="hash-link" aria-label="Direct link to Why 14-Day Horizon?" title="Direct link to Why 14-Day Horizon?" translate="no">​</a></h3>
<p><strong>Forecast Agent</strong>: Produces 14-day forecasts</p>
<p><strong>Reasons</strong>:</p>
<ol>
<li class="">Matches forecast capability</li>
<li class="">Computational efficiency (shorter horizon = faster LP solve)</li>
<li class="">Academic precedent (Secomandi 2010 uses 7-14 day windows)</li>
</ol>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="why-harvest-based-inventory">Why Harvest-Based Inventory?<a href="#why-harvest-based-inventory" class="hash-link" aria-label="Direct link to Why Harvest-Based Inventory?" title="Direct link to Why Harvest-Based Inventory?" translate="no">​</a></h3>
<p><strong>Traditional approach</strong> (wrong):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 1: Start with 50 tons</span><br></span></code></pre></div></div>
<p><strong>Realistic approach</strong> (ours):</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Day 1: Inventory = 0.327 tons (first day of harvest)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Day 153: Inventory = 50 tons (end of harvest)</span><br></span></code></pre></div></div>
<p><strong>Why?</strong></p>
<ul>
<li class="">Models realistic producer behavior</li>
<li class="">Prevents unrealistic early liquidation</li>
<li class="">Accurate cost accounting (storage costs accumulate as inventory grows)</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="force-liquidation">Force Liquidation<a href="#force-liquidation" class="hash-link" aria-label="Direct link to Force Liquidation" title="Direct link to Force Liquidation" translate="no">​</a></h3>
<p>All strategies inherit from <code>Strategy</code> base class:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_force_liquidation_check</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Sell all inventory at max_holding_days&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> day greater than </span><span class="token keyword" style="color:#00009f">or</span><span class="token plain"> equal to  self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_holding_days</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Usually 365</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;action&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;SELL&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;amount&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> inventory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;reason&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;force_liquidation_max_days&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><br></span></code></pre></div></div>
<p><strong>Reason</strong>: Quality degradation after 1 year.</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="cooldown-periods">Cooldown Periods<a href="#cooldown-periods" class="hash-link" aria-label="Direct link to Cooldown Periods" title="Direct link to Cooldown Periods" translate="no">​</a></h3>
<p>Most strategies use 7-day cooldown:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> days_since_sale </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cooldown_days</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> HOLD</span><br></span></code></pre></div></div>
<p><strong>Reason</strong>: Prevents overtrading (transaction costs add up).</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="batch-sizes">Batch Sizes<a href="#batch-sizes" class="hash-link" aria-label="Direct link to Batch Sizes" title="Direct link to Batch Sizes" translate="no">​</a></h3>
<p>All strategies use fractional batch sizes (0.0 to ~0.40):</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">batch_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.25</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Sell 25% of inventory</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">amount </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inventory </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> batch_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Example:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># inventory = 50 tons</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># batch_size = 0.25</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># amount = 12.5 tons sold</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># remaining = 37.5 tons</span><br></span></code></pre></div></div>
<p><strong>Why fractions?</strong></p>
<ul>
<li class="">Gradual liquidation reduces risk</li>
<li class="">Avoids all-or-nothing decisions</li>
<li class="">Dollar-cost averaging benefit</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="parameter-optimization">Parameter Optimization<a href="#parameter-optimization" class="hash-link" aria-label="Direct link to Parameter Optimization" title="Direct link to Parameter Optimization" translate="no">​</a></h3>
<p>All parameters can be optimized using Optuna:</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Default parameters</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;batch_size&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.25</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;threshold_pct&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Optimized parameters (from Optuna)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">optimized_params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> load_from_json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;optimized_params_coffee_model_v1.json&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p>See <code>parameter_manager.py</code> for automatic fallback logic.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="testing-and-validation">Testing and Validation<a href="#testing-and-validation" class="hash-link" aria-label="Direct link to Testing and Validation" title="Direct link to Testing and Validation" translate="no">​</a></h2>
<p>All strategies tested via <code>BacktestEngine</code> with:</p>
<ul>
<li class="">Harvest-based inventory (starts at zero, accumulates)</li>
<li class="">Cost modeling (storage + transaction)</li>
<li class="">Force liquidation (365 days max)</li>
<li class="">Multi-year backtests (2020-2024)</li>
</ul>
<p><strong>Statistical validation</strong>:</p>
<ul>
<li class="">Paired t-tests vs baselines</li>
<li class="">Bootstrap confidence intervals</li>
<li class="">Sign tests for consistency</li>
<li class="">Cohen&#x27;s d for effect size</li>
</ul>
<p>See <code>statistical_tests.py</code> (1,292 lines) for implementation.</p>
<hr>
<p><strong>Document Status</strong>: ✅ COMPLETE - Comprehensive technical reference
<strong>Last Updated</strong>: 2025-12-10
<strong>Source Code</strong>: <code>/Users/markgibbons/capstone/ucberkeley-capstone/trading_agent/production/strategies/</code></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/gibbonstony/ucberkeley-capstone/tree/main/docs/trading-agent/strategies.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/groundtruth-docs/docs/trading-agent/introduction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Trading Agent</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#table-of-contents" class="table-of-contents__link toc-highlight">Table of Contents</a></li><li><a href="#system-context" class="table-of-contents__link toc-highlight">System Context</a><ul><li><a href="#the-commodity-producer-scenario" class="table-of-contents__link toc-highlight">The Commodity Producer Scenario</a></li><li><a href="#harvest-cycle-management" class="table-of-contents__link toc-highlight">Harvest Cycle Management</a></li><li><a href="#multi-year-backtesting" class="table-of-contents__link toc-highlight">Multi-Year Backtesting</a></li></ul></li><li><a href="#technical-indicators-explained" class="table-of-contents__link toc-highlight">Technical Indicators Explained</a><ul><li><a href="#rsi-relative-strength-index" class="table-of-contents__link toc-highlight">RSI (Relative Strength Index)</a></li><li><a href="#adx-average-directional-index" class="table-of-contents__link toc-highlight">ADX (Average Directional Index)</a></li><li><a href="#cv-coefficient-of-variation" class="table-of-contents__link toc-highlight">CV (Coefficient of Variation)</a></li><li><a href="#moving-average-ma" class="table-of-contents__link toc-highlight">Moving Average (MA)</a></li></ul></li><li><a href="#cost-model" class="table-of-contents__link toc-highlight">Cost Model</a><ul><li><a href="#storage-cost" class="table-of-contents__link toc-highlight">Storage Cost</a></li><li><a href="#transaction-cost" class="table-of-contents__link toc-highlight">Transaction Cost</a></li></ul></li><li><a href="#baseline-strategies" class="table-of-contents__link toc-highlight">Baseline Strategies</a><ul><li><a href="#1-immediate-sale-strategy" class="table-of-contents__link toc-highlight">1. Immediate Sale Strategy</a></li><li><a href="#2-equal-batch-strategy" class="table-of-contents__link toc-highlight">2. Equal Batch Strategy</a></li><li><a href="#3-price-threshold-strategy" class="table-of-contents__link toc-highlight">3. Price Threshold Strategy</a></li><li><a href="#4-moving-average-strategy" class="table-of-contents__link toc-highlight">4. Moving Average Strategy</a></li></ul></li><li><a href="#prediction-based-strategies" class="table-of-contents__link toc-highlight">Prediction-Based Strategies</a><ul><li><a href="#5-price-threshold-predictive-matched-pair" class="table-of-contents__link toc-highlight">5. Price Threshold Predictive (Matched Pair)</a></li><li><a href="#6-moving-average-predictive-matched-pair" class="table-of-contents__link toc-highlight">6. Moving Average Predictive (Matched Pair)</a></li><li><a href="#7-expected-value-strategy-standalone" class="table-of-contents__link toc-highlight">7. Expected Value Strategy (Standalone)</a></li><li><a href="#8-consensus-strategy-standalone" class="table-of-contents__link toc-highlight">8. Consensus Strategy (Standalone)</a></li><li><a href="#9-risk-adjusted-strategy-standalone" class="table-of-contents__link toc-highlight">9. Risk-Adjusted Strategy (Standalone)</a></li></ul></li><li><a href="#optimization-strategy" class="table-of-contents__link toc-highlight">Optimization Strategy</a><ul><li><a href="#10-rolling-horizon-mpc-model-predictive-control" class="table-of-contents__link toc-highlight">10. Rolling Horizon MPC (Model Predictive Control)</a></li></ul></li><li><a href="#academic-references" class="table-of-contents__link toc-highlight">Academic References</a><ul><li><a href="#core-citations-high-impact" class="table-of-contents__link toc-highlight">Core Citations (High Impact)</a></li><li><a href="#strategy-to-citation-mapping" class="table-of-contents__link toc-highlight">Strategy-to-Citation Mapping</a></li></ul></li><li><a href="#design-decisions" class="table-of-contents__link toc-highlight">Design Decisions</a><ul><li><a href="#why-3-tier-prediction-system" class="table-of-contents__link toc-highlight">Why 3-Tier Prediction System?</a></li><li><a href="#why-coefficient-of-variation-cv" class="table-of-contents__link toc-highlight">Why Coefficient of Variation (CV)?</a></li><li><a href="#why-median-instead-of-mean" class="table-of-contents__link toc-highlight">Why Median Instead of Mean?</a></li><li><a href="#why-14-day-horizon" class="table-of-contents__link toc-highlight">Why 14-Day Horizon?</a></li><li><a href="#why-harvest-based-inventory" class="table-of-contents__link toc-highlight">Why Harvest-Based Inventory?</a></li><li><a href="#force-liquidation" class="table-of-contents__link toc-highlight">Force Liquidation</a></li><li><a href="#cooldown-periods" class="table-of-contents__link toc-highlight">Cooldown Periods</a></li><li><a href="#batch-sizes" class="table-of-contents__link toc-highlight">Batch Sizes</a></li><li><a href="#parameter-optimization" class="table-of-contents__link toc-highlight">Parameter Optimization</a></li></ul></li><li><a href="#testing-and-validation" class="table-of-contents__link toc-highlight">Testing and Validation</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Agents</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/groundtruth-docs/docs/research-agent/introduction">Research Agent</a></li><li class="footer__item"><a class="footer__link-item" href="/groundtruth-docs/docs/forecast-agent/introduction">Forecast Agent</a></li><li class="footer__item"><a class="footer__link-item" href="/groundtruth-docs/docs/trading-agent/introduction">Trading Agent</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Resources</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/gibbonstony/ucberkeley-capstone" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub Repository<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://studiomios.wixstudio.com/caramanta" target="_blank" rel="noopener noreferrer" class="footer__link-item">Live System<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">UC Berkeley MIDS</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.ischool.berkeley.edu/" target="_blank" rel="noopener noreferrer" class="footer__link-item">School of Information<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.ischool.berkeley.edu/programs/mids" target="_blank" rel="noopener noreferrer" class="footer__link-item">MIDS Program<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">UC Berkeley Master of Information and Data Science (MIDS) Capstone Project 2024<br>Built with Docusaurus</div></div></div></footer></div>
</body>
</html>